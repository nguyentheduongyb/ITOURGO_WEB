@{

    var langID = APP_B2B_PUB.Controllers.HomeController.GetLangID(Request.QueryString["lang"]);


    @functions {
        public static string GetUrl(string strTxt)
        {
            return APP_B2B_PUB.Controllers.HomeController.GetUrl(strTxt);
        }
        public static string GetFormatDateTime(string strTxt)
        {
            return APP_B2B_PUB.Controllers.HomeController.GetFormatDateTime(strTxt);
        }
    }


    var strTitle = "Giỏ hàng";

    string storageItem = Request.QueryString["lang"];

    //HttpCookieCollection cook = Request.Cookies;
    //var value = Request.Cookies["lang"].Value;

    ViewBag.Lang = Request.QueryString["lang"];
    ViewBag.Title = strTitle;
    ViewBag.Keywords = "B2B Du lịch, kết nối đại lý, đại lý bán, đại lý mua, khách du lịch";
    ViewBag.Description = "Một nền tảng giúp các công ty và các nhà cung cấp dịch vụ du lịch kết nối đến các đại lý của họ.Hệ thống giúp mở rộng kênh bán hàng, tăng doanh số, giảm chi phí.    Tạo mối liên kết mở rộng B2B giữa các doanh nghiệp, giúp các công ty phát triển bền vững";
}
<app-content-display>

    <div id="Content" style="background: #F5F7F8">
        <div class="panel-itl">
            <div class="container">
                <div class="row">
                    <div id="pnTitle" class="col-md-12" style="display:flow-root">

                        <h1 style="display:inline-block;float: left;">@strTitle</h1>

                    </div>

                    <div id="pnFormFilter" class="col-md-12 pn-margin-b-30">

                    </div>

                    <div class="col-md-12">
                        <div id="pnTableMn" class=""></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        
$.ModulePage_ListOrderBookingMain = function (options) {
    var defaults = {
        strUserGUID:JSON.parse(png.ArrLS.UserDetail.get()).strPassengerGUID,
    }
    options = $.extend(defaults, options);
    var IdOrClass_Main= '#Content #pnTableMn'

    var ObjList_Api = { 
        GetListOrderBooking:{
            strApiLink:'api/booking/GetListOrderBooking' 
            ,objParams:{ 
                strPassengerGUID:options.strUserGUID
                ,strCompanyPartnerGUID: options.strCompanyPartnerGUID
                ,strCompanyOwnerGUID: options.strCompanyOwnerGUID
                ,strOrderBookingGUID: null
                ,strFilterOrderBookingCode: null
                ,strFilterGroupName: null
                ,strFilterDateFrom: null
                ,strFilterDateTo: null
                ,intCurPage:1
                ,intPageSize:10
                ,strOrder:null
                ,tblsReturn:'[0]'
            }
        },

        GetListPassengerOrderByAgentHost:{
            strApiLink:'api/traveller/GetListPassengerOrderByAgentHost' 
            ,objParams:{ 
                strPassengerGUID:options.strUserGUID
                ,strPassengerOrderByAgentHostGUID : null
                ,intCurPage:1
                ,intPageSize:10
                ,strOrder:null
                ,tblsReturn:'[0]'
            }
        },
        GetListPassengerOrderItem:{
            strApiLink:'api/traveller/GetListPassengerOrderItem' 
            ,objParams:{ 
                strPassengerGUID:options.strUserGUID,
                strPassengerOrderItemGUID : null,
                strPassengerOrderByAgentHostGUID : null,
                intCurPage : null,
                intPageSize : null,
                strOrder : null,
                tblsReturn : '[0]',
            }
        },

        DelOrderBookingItem:{
            strApiLink:'api/booking/DelOrderBookingItem' 
            ,objParams:{ 
                strUserGUID:options.strUserGUID,
                strPassengerOrderItemGUID : null,
            }
        },
    }


    
    //---------
    var Obj_Filter = {}         // Biến lọc
    // var Obj_FormInput = {}
    var Arr_ListTbl_Com = []
    var Arr_ListTbl = []
    var Arr_ListTbl_2 = []
    
    var Obj_FN_Main = {}  
    //---------        \\


    GetMainPanel()
    function GetMainPanel(){

        var objPanel = {
            pnMain:{tag:'div',attr:'class=""',childTags:[{div:'class="container"'},{div:'class="row"'}]
                ,pnTitle:{tag:'div',attr:'class="col-md-12 " style="display:flow-root"'}
                // ,pnFormFilter:{tag:'div',attr:'class="col-md-12 pn-margin-b-30"'}
                ,pnTable:{tag:'div',attr:'class="col-md-12"'}
            }
        }

        var objEvtPanel = {}
        objEvtPanel.pnTitle = function(_idOrClassPn){  
            var IdOrClassPn = _idOrClassPn

            
            var strHtml = ''
                // strHtml+= '<h1 style="display:inline-block;float: left;">Giỏ hàng</h1>'
                // strHtml+= '<button class="btn btn-texticon btn-default" id="btnVideoHelper" style="float: left;margin-left:15px"><i class="fa fa-question-circle"></i><span><i class="fa fa-film"></i></span></button>'
                strHtml+='<div class="pnFloat"></div>'
            $(IdOrClassPn).html(strHtml)


            
            strHtml = ''
            strHtml+=`
            
                <div id="pnFloat" style="position: fixed; top: 10%; right: 0; background: #fff;width:250px; padding: 15px 0; box-shadow: 0px 0px 22px -8px #000; border-radius: 10px; z-index: 9;">
                    <i class="btnClose fa fa-times" style="padding: 7px;position: absolute;top: 0;right: 0;cursor: pointer;font-size: 20px;"></i>
                    

                    <div style="margin-top:30px" class="pnForm col-md-12">
                        <div class="row" style="font-weight:bold;background:#F5F7F8;padding:7px 0">
                            <div class="col-md-7 col-xs-6">Số dịch vụ</div><div class="col-md-5 col-xs-6" align="right"><span class="intITs"></span></div>
                        </div>
                        <div class="row" style="font-weight:bold;padding:7px 0">
                            <div class="col-md-7 col-xs-6">${pngElm.getLangKey({langkey:'sys_Txt_SubTotal'})}</div><div class="col-md-5 col-xs-6" align="right"><span class="dblTotalPrice"></span></div>
                        </div>
                        <div class="row" style="color:#707070;padding:7px 0;border-bottom:1px solid #ccc">
                            <div class="col-md-7 col-xs-6">Voucher</div><div class="col-md-5 col-xs-6" align="right">${0}</div>
                        </div>
                        <div class="row" style="color:#257EF8;font-weight:bold;padding:7px 0">
                            <div class="col-md-7 col-xs-6">Tổng giá:</div><div class="col-md-5 col-xs-6" align="right"><span class="dblTotalPrice"></span></div>
                        </div>
                    </div>
                    <div class="pn-padding-l-r-15 row">
                        <div class="col-md-12">
                            
                            <span class="txtErr" style="color:red"></span>
                            <button id="btnSave" class="btn" style="width:100%;border-radius:10em;padding:5px;margin-top:10px;background:#257EF8;color:#fff">Mua dịch vụ</button>
                        </div>
                    </div>

                </div>
            `
            $(IdOrClassPn+' .pnFloat').html(strHtml)
            $(IdOrClassPn+ " #pnFloat").hide()

            
            $('.btnClose','#pnFloat').click(function(){
                // Arr_ListTbl.forEach(function(value){
                //     value.IsEnableInput = 0
                // })
                $('.IsEnableInput:checked',IdOrClass_Main+' #pnTable').prop('checked',false).change()
            })

            $('#btnSave',IdOrClassPn+ " #pnFloat").click(function(){

                var ArrSer = Arr_ListTbl.filter(function(item){ return item.IsEnableInput || item.IsEnableInput2 })
                var ArrCom = Arr_ListTbl_Com.filter(function(item){ return ArrSer.filter(function(item2){ return item2.strCompanyGUID.toUpperCase() == item.strCompanyGUID.toUpperCase() }).length })

                
                
                ArrSer.forEach(function(value){
                    if(value.IsMaster){
                        var arrItem =  ArrSer.filter(function(item){ return (item.strSupplierGUID || '').toUpperCase() == value.strSupplierGUID.toUpperCase() && !item.IsMaster })
                       
                        if(arrItem.length){
                            
                            var dblPriceTotalAgentCom = 0
                            var dblPriceTotal = 0

                            arrItem.forEach(function(val){
                                // dblPriceTotalAgentCom+= (val.dblPriceTotalAgentCom || 0)
                                dblPriceTotal+= (val.dblPriceTotal || 0)
                            })
                            value.dblPriceTotalAgentCom = dblPriceTotalAgentCom
                            value.dblPriceTotal = dblPriceTotal
                            

                        }
                    }
                })
                
                $.fn.loadJS(coreSystem.getLinkVer('Lib_Custom/_MdCm_All.js'))
                $.ModuleCommon_All_PopUpPaymentBooking({
                    strUserGUID: options.strUserGUID
                    ,strCompanyPartnerGUID: null
                    ,arrListAgentHost: ArrCom
                    ,arrListService: ArrSer
                    ,OnSuccess: function () {
                    }
                })

            })


            //coreLoadPage.viewVideoHelper({
            //    strUserGUID: options.strUserGUID
            //    ,strTravelHelperSubModuleCode: 'E9C37'
            //    ,intLangID: $.pngGetLangID()
            //    ,idOrClassBtn:'#btnVideoHelper'
            //})
        }

        objEvtPanel.pnFormFilter = function(_idOrClassPn){  
            var IdOrClassPn = _idOrClassPn
            var objInput = {
                strFilterOrderBookingCode: {
                    title: '', attr: 'style="border-right: 1px solid #D6D6D6;"', isRequire: false, IsRtn: true
                    , input: { type: 'text', classEx: 'form-control pn-border-none pn-shadow-none bg-none', attr: 'placeholder="'+pngElm.getLangKey({langkey:'pg_Dft_TC_LtOrBk_OrderCode'})+'" style="padding-left:15px"' } //maxlength="30"
                }
                ,strFilterGroupName: {
                    title: '', attr: 'style="border-right: 1px solid #D6D6D6;"', isRequire: false, IsRtn: true
                    , input: { type: 'text', classEx: 'form-control pn-border-none pn-shadow-none bg-none', attr: 'placeholder="Group Name" style="padding-left:15px"' } //maxlength="30"
                }
                ,strFilterDateFrom_strFilterDateTo: {
                    title: '', attr: 'style="border-right: 1px solid #D6D6D6;"', isRequire: false, IsRtn: true
                    ,datePickerRange:{todayHighlight: true,format: 'dd/mm/yyyy',weekStart: 1,startDate: null,endDate: null}
                }
                // ,intOrderStatusID: {
                //     title: pngElm.getLangKey({langkey:'pg_Dft_TC_LtBk_BookingStatus'}), attr: '', isRequire: false, IsRtn: true
                //     , input: { type: 'select', classEx: 'form-control pn-border-none pn-shadow-none bg-none', attr: 'style="border-right:1px solid #909090;padding-left:15px"' } //maxlength="30"
                //     ,dropDown:{arrList:Arr_OrderStatus_Ddl}
                // }
            }
            
    
            pngPn.getFormHorizontal({
                objInput: objInput
                , idOrClass: IdOrClassPn
                , objDetail:{}
                , classEx:'bg-white pn-round-1em'
                , attr: 'style="border: 1px solid #D6D6D6;"'
                , strHtmlBtn:'<button id="btnFilter" class="btn bg-primary txt-white pn-round-1em pn-round-t-l-0 pn-round-b-l-0"><i class="fa fa-search"></i></button>'
            })
    
            $('.input-daterange input',IdOrClassPn).css('border','none').css('width','140px')
            $('.input-daterange .input-group-addon',IdOrClassPn).css('border','none')
    
            $(IdOrClassPn).DefaultButton(IdOrClassPn + ' #btnFilter')
    
            $(IdOrClassPn + ' #btnFilter').click(function(){
                pngPn.getForm({
                    action: 2,
                    objInput: objInput,
                    idOrClass: IdOrClassPn,
                    OnChkSuccess: chkSuccess
                })
                function chkSuccess(objRtn){
                    Obj_Filter = objRtn
                    Obj_FN_Main.pnMain('pnTable')
                    
                }
            })
        }

        objEvtPanel.pnTable = function(_idOrClassPn){  
            var IdOrClass_Pn = _idOrClassPn

            $(IdOrClass_Pn).html(`
                <div id="pnCnt1" class="bg-white pn-padding-15 pn-round-1em"></div>
                <div>
                    <h3 class="pn-margin-t-b-15">Các dịch vụ không hợp lệ</h3>
                    <div  id="pnCnt2" class="bg-white pn-padding-15 pn-round-1em"></div>
                </div>
            `)

            //---------ObjConfigLang
            //---------ArrConfigLang
            //---------IsConfigLang
            //---------IntConfigLang
            //---------StrConfigLang

            var objCols = {'No':{name:'<span langkey="sys_Txt_Tbl-No"></span>'}
                ,strOrderBookingCode:{name:'<span langkey="pg_Dft_TC_LtOrBk_OrderCode"></span>'}
                ,strGroupName_View:{name:'Group name'}
                ,strDtmDateFromDateTo:{name:'Date From - Date To'}
                ,intTotalPax:{name:'<span langkey="pg_Dft_TC_LtOrBk_TotalPax"></span>',strAttrTD:' style="text-align:right"'}
                ,dblPriceTotal_View:{name:'<span langkey="pg_Dft_TC_LtOrBk_TotalPrice"></span>',strAttrTD:' style="text-align:right"'}
                ,strHtmlAction :{name:'<span langkey="sys_Txt_Tbl-Action"></span>',strAttrTH:'style="width:150px"'}
                // ,IsBooked:{name:'<span langkey="pg_Dft_TC_LtOrBk_BookingStatus"></span>'}
            }

            if ($(window).width() < 767){
                objCols = {'No':{name:'<span langkey="sys_Txt_Tbl-No"></span>'}
                    
                    ,strOrderBookingCode :{name:'<span langkey="pg_Dft_TC_LtOrBk_OrderCode"></span>', strAttrTD: "style='vertical-align: top' "
                        ,list_input:{
                                    
                            strOrderBookingCode:{title:'',attr:"class='col-md-12' "
                                ,input:{IsNoInput:true,IsViewDtl:true}
                            },   
                            strDtmDateFromDateTo:{title:'',attr:"class='col-md-12' style='margin-bottom:5px"
                                ,input:{IsNoInput:true,IsViewDtl:true}
                            },
                            intTotalPax:{title:'<span langkey="pg_Dft_TC_LtBk_GroupSize"></span>',attr:"class='col-md-12' style='margin-bottom:5px'"
                                ,input:{IsNoInput:true,IsViewDtl:true}
                            },
                        }
                    }
                    ,dblPriceTotal :{name:'<span langkey="pg_Dft_TC_LtOrBk_TotalPrice"></span>', strAttrTD: "style='vertical-align: top' "
                        ,list_input:{
                            dblPriceTotal_View:{title:'',attr:"class='col-md-12' style='margin-bottom:5px'"
                                ,input:{IsNoInput:true,IsViewDtl:true}
                            },
                            strHtmlAction:{title:'',attr:"class='col-md-12' style='margin-bottom:5px'"
                                ,input:{IsNoInput:true,IsViewDtl:true}
                            },
                            
                        }
                    }
                }
    
            }
            objCols['strIsPassengerBooked_View'] = {IsColSpecial:true
                ,strStyle: { '0': '', '1': 'background:#d7e8ff;' }
            }


            // Arr_ListTbl_Com.forEach(function(value){
            //     var strHtml = ''
            //     strHtml+=`
            //         <div class="pn-margin-b-15">
            //             <h4 class="pn-margin-b-15"><i class="fa fa-briefcase"></i> ${value.strCompanyName}</h4>
            //             <div class="pnTable_${value.strCompanyGUID}">${value.strCompanyName}</div>
            //         </div>
            //     `
            //     $(IdOrClass_Pn+'>div').append(strHtml)
            //     // GetTable(IdOrClassPn+' .pnTable_'+value.strCompanyGUID,value)

            // })

            var i= 1
            Arr_ListTbl_Com = []
            GetData(i)
            $(window).scroll(function(){
                if($(IdOrClass_Pn).find('[exData='+(i+1)+']').length){
                    if ( $(this).scrollTop()+$(this).height() > $(IdOrClass_Pn).find('[exData='+(i+1)+']').offset().top ) {
                        $(IdOrClass_Pn).find('[exData='+(i+1)+']').removeAttr('exData')
                        i+=1
                        GetData(i)
                    }
                }
            })

            function GetData(_intCurPage){

                var ArrListItem = []

                png.postListApiGetValue({           // Post list các Api phía trên và lấy về dữ liệu
                    objList_Api: ObjList_Api            // Tên các Object api đã khai báo phía trên 
                    // ,objList_ComboValue: ObjList_ComboValue // Tên các Object api dropdownlist đã khai báo phía trên 
                    ,objListApi_RtnVal: {           // Giá trị nhận về từ API
                        'GetListPassengerOrderByAgentHost':{               // Tên api tương ứng với giá trị trả về
                            objParams_Cus: $.pngExtendObj(Obj_Filter,{
                                intCurPage : _intCurPage
                                ,intPageSize : 5
                            })
                            ,OnSuccess: function(data){
                                
                                ArrListItem = JSON.parse(data)[0]   // Dữ liệu trả về từ api trên

                                Arr_ListTbl_Com = Arr_ListTbl_Com.concat(JSON.parse(JSON.stringify(ArrListItem)));   // Dữ liệu trả về từ api trên
                                GetList()
                            }
                        }
                    }
                })

                
                function GetList(){

                    ArrListItem.forEach(function(value,key){
                        var strHtml = ''
                        
                        var attrExData = ''
                        if(key==4){
                            attrExData = 'exData="'+(_intCurPage+1)+'"'
                        }

                        strHtml+=`
                            <div class="pn-margin-b-15" intCurPage="${_intCurPage}"  intRowID="${key}" ${attrExData}>
                                <h4 class="pn-margin-b-15"><i class="fa fa-briefcase"></i> ${value.strCompanyName}</h4>
                                <div class="pnTable_${value.strCompanyGUID}"></div>
                            </div>
                        `
                        $(IdOrClass_Pn+' #pnCnt1').append(strHtml)
                        
                        strHtml=`
                            <div class="pn-margin-b-15" intCurPage="${_intCurPage}"  intRowID="${key}" ${attrExData}>
                                <h4 class="pn-margin-b-15"><i class="fa fa-briefcase"></i> ${value.strCompanyName}</h4>
                                <div class="pnTable_${value.strCompanyGUID}"></div>
                            </div>
                        `
                        $(IdOrClass_Pn+' #pnCnt2').append(strHtml)

                        GetTable(IdOrClass_Pn+' #pnCnt1 .pnTable_'+value.strCompanyGUID,value)
                        GetTable2(IdOrClass_Pn+' #pnCnt2 .pnTable_'+value.strCompanyGUID,value)
                    })

                }
            }

            function GetTable(_idOrClass_Pn,_obj){

                var IdOrClass_Pn = _idOrClass_Pn

                Arr_ListTbl = Arr_ListTbl.filter(function(item){ return item.strCompanyGUID.toUpperCase() != _obj.strCompanyGUID.toUpperCase() })

                $(_idOrClass_Pn).show()

                var arr = []//Arr_ListTbl.filter(function(item){ return item.strCompanyGUID == _obj.strCompanyGUID })
                
                pngPn.getTable2({
                    objApi: ObjList_Api.GetListPassengerOrderItem
                    ,objParams_Cus:{
                        strPassengerOrderByAgentHostGUID: _obj.strPassengerOrderByAgentHostGUID
                    }
                    ,editRltArr: function(_arr,_arrAll){
                        
                        // _arr = _arr.filter(function(item){ return moment($.pngFormatDateTime(item.dtmDateFrom,'l')) > moment()  && (item.intRemain == null || (item.intQuantity && item.intQuantity < item.intRemain)) })

                        _arr.forEach(function(value){
                            var IsView = true
                            if(moment($.pngFormatDateTime(value.dtmDateFrom,'l')).diff(moment(), 'days') < 0 && !value.IsMaster ){
                                IsView = false
                            }
                            if(!(value.intRemain == null || (value.intRemain && value.intQuantity && value.intQuantity < value.intRemain)) ){
                                IsView = false
                            }

                            if(value.intLevel == 2){
                                if(!arr.filter(function(item){ return (item.strPassengerOrderItemGUID || '').toUpperCase() == (value.strParentPassengerOrderItemGUID || '').toUpperCase() }).length)
                                    IsView = false
                            }
                            if(IsView)
                                arr.push(value)
                        })

                        if(!arr.length){
                            $(_idOrClass_Pn).parent().hide()
                        }

                        arr.forEach(function(value){
                            if(value.IsMaster){
                                var arrItem =  arr.filter(function(item){ return (item.strSupplierGUID || '').toUpperCase() == value.strSupplierGUID.toUpperCase() && !item.IsMaster })
                               
                                if(arrItem.length){
                                    
                                    var dblPriceTotalAgentCom = 0
                                    var dblPriceTotal = 0

                                    arrItem.forEach(function(val){
                                        dblPriceTotalAgentCom+= (val.dblPriceTotalAgentCom || 0)
                                        dblPriceTotal+= (val.dblPriceTotal || 0)
                                    })
                                    value.dblPriceTotalAgentCom = dblPriceTotalAgentCom
                                    value.dblPriceTotal = dblPriceTotal
                                    value.dblTotalCommission_View =$.pngFormatPrice(dblPriceTotalAgentCom)

                                }else{
                                    value.IsNotView = 1
                                }
                            }
                        })
                        
                        arr = arr.filter(function(item){ return !item.IsNotView })
                        // arr = _arr
                        Arr_ListTbl = Arr_ListTbl.concat(arr);
                        // arr = Arr_ListTbl.filter(function(item){ return item.strCompanyGUID.toUpperCase() == _obj.strCompanyGUID.toUpperCase() })
                        return arr
                    }
                    ,editRlt: function(value,key){
                        value['No'] = (key+1)
                        // value['strIsPassengerBooked_View'] = (value['IsPassengerBooked']?1:0)
                        
                        // value['strGroupName_View'] = (value['strGroupName'] || '')+(value['IsPassengerBooked']? '<div><i>(Book from Traveller)</i></div>':'')
                        
                        if(value.strTourGUID)
                            value['strServiceName_View'] = '<a href="/tour/'+value.strServiceNameUrl+'">'+value['strServiceName']+'</a>'
                        else if(value.strSupplierGUID)
                            value['strServiceName_View'] = '<a href="?menuid=2b7a2657-18eb-4703-8573-fa43b8dda001&module=detail&idmdit='+value.strSupplierGUID+'">'+value['strServiceName']+'</a>'
                        else
                            value['strServiceName_View'] = value['strServiceName']

                        if(!value.IsMaster)
                            value['strServiceName_View']+= '<div>'+ $.pngFormatDateTime(value.dtmDateFrom) + ' - ' + $.pngFormatDateTime(value.dtmDateTo)+'</div>'
                        
                        var intMar = 0
                        if(value.intLevel == 1)
                            intMar = '15px'
                        
                        if(value.intLevel == 2)
                            intMar = '30px'

                        value['strServiceName_View'] = '<div style="margin-left: '+intMar+'">'+value['strServiceName_View']+'</div>'
                        
                        value['strDtmDateFromDateTo'] = $.pngFormatDateTime(value.dtmDateFrom) + ' - ' + $.pngFormatDateTime(value.dtmDateTo)

                        if(value.strTourGUID)
                            value['dblPriceTotal_View'] = '<a action="PriceDetail">'+$.pngFormatPrice(value.dblPriceTotal)+'</a>'
                        else
                            value['dblPriceTotal_View'] = $.pngFormatPrice(value.dblPriceTotal)
                        
                        value.IsShowCheckbox= false
                        if(value.strTourGUID){
                            value.IsShowCheckbox = true
                        }
                        if(value.strSupplierGUID && ((value.strItemTypeGUID && !value.strSupplierChildAgeGUID) || value.IsMaster)){
                            value.IsShowCheckbox = true
                        }



                        if(!value.dblPriceTotalAgentCom)
                            value['dblTotalCommission_View'] = 'N/A'
                        else
                            value['dblTotalCommission_View'] = $.pngFormatPrice(value.dblPriceTotalAgentCom)
                    
                        if(!value['IsMaster']){
                            if(value['strFocGUID']){
                                value['intTotalPax_View'] =value['intQuantity']
                            }else{
                                value['intTotalPax_View'] = '<a action="EditPax">'+value['intQuantity']+'</a>'
                            }
                        }
                        else
                            value['intTotalPax_View'] = ''

                        if(value.intRemain != null){
                            if(value.strTourGUID){
                                value['intTotalPax_View']+= ' (<i class="fa fa-male"></i> '+value.intAdultsInService+' - <i class="fa fa-child"></i> '+(value.intChildren || 0 )+')'
                                value['intTotalPax_View']+= '<div>(Số chỗ còn lại: '+value.intRemain+')</div>'
                            }
                            if(value.strItemTypeGUID)
                                value['intTotalPax_View']+= '<div>(Available: '+value.intRemain+')</div>'
                        }
                            
                            
                        if(value['strType'])
                            value['strType_View'] = value['strType']+'<a action="Edit">Chỉnh sửa</a>'
                        // var strUrl = coreLoadPage.getUrlHost()
                        // strUrl = $.pngGetQSVal('cname', $.pngGetQSVal('cname'),strUrl)
                        // strUrl = $.pngGetQSVal('page', 'order',strUrl)
                        // strUrl = $.pngGetQSVal('GUID', value.strOrderBookingGUID,strUrl)
                        value['strHtmlAction'] = ''
                        if(value.IsShowCheckbox)
                            value['strHtmlAction']+= '<button class="btn" action="Delete" intRowID="' + key + '"><i class="fa fa-trash"></i></button>'
                        
                    }
                    ,objCols: {
                        
                        No: { name: '<span langkey="sys_Txt_No"></span>' },
                        strServiceName_View: { name: 'Service name' },
                        strType_View: { name: 'Type' },
                        intTotalPax_View:{name:'Quantity',strAttrTD:' style="text-align:right"'},
                        dblPriceTotal_View:{name:'<span langkey="pg_Dft_TC_LtOrBk_TotalPrice"></span>',strAttrTD:' style="text-align:right"'},
                        // dblTotalCommission_View:{name:'Total commission',strAttrTD:' style="text-align:right"'},
                        strHtmlAction: { name: '<span langkey="sys_Txt_Action"></span>' },
                    }
                    // ,editTableInput:function(){}
                    , changeCkbMaster: function (IsChecked, intRowID,arrList) {
    
                        arr[intRowID].IsEnableInput = IsChecked

                        arr.forEach(function(value){
                            if((value.strParentPassengerOrderItemGUID || '').toUpperCase() == (arr[intRowID].strPassengerOrderItemGUID || '').toUpperCase()  
                                || (value.strPassengerOrderItemGUID || '').toUpperCase() == (arr[intRowID].strParentPassengerOrderItemGUID || '').toUpperCase()  
                            )
                                value.IsEnableInput2 = IsChecked
                        })

                        var ArrSelect = Arr_ListTbl.filter(function(item){ return item.IsEnableInput || (item.IsEnableInput2 && !item.IsMaster) })
                        console.log(ArrSelect)
                        if(ArrSelect.length == 0){
                            $(IdOrClass_Main+ " #pnFloat span.intITs").text('')
                            $(IdOrClass_Main+ " #pnFloat").hide()
                        }else{
                            var dblTotalPrice = 0
                            var dblPriceTotalAgentCom = 0
                            ArrSelect.forEach(function(value){
                                dblTotalPrice+=value.dblPriceTotal
                                dblPriceTotalAgentCom+=value.dblPriceTotalAgentCom
                            })

                            $(IdOrClass_Main+ " #pnFloat span.intITs").text(''+ArrSelect.length+'' )
                            $(IdOrClass_Main+ " #pnFloat span.dblTotalPrice").html($.pngFormatPrice(dblTotalPrice))
                            $(IdOrClass_Main+ " #pnFloat span.dblPriceTotalAgentCom").html($.pngFormatPrice(dblPriceTotalAgentCom))
                            
                            $(IdOrClass_Main+ " #pnFloat").show()
                        }
    
                        // arr = arrList
                    }
                    ,customEvent: function(_idOrClass_Pn){

                        arr.forEach(function(value,key){
                            if(!value.IsShowCheckbox || value.IsMaster)
                                $('[row='+key+'] .IsEnableInput',_idOrClass_Pn).hide()
                        })
    
                        $(_idOrClass_Pn + ' a').click(function(){
                            var intRowID = $(this).parents('tr').attr('row')
                            var action = $(this).attr('action')
    
                            if(action == 'PriceDetail'){
                                GetPopUp_PriceDetail({
                                    objDetail: arr[intRowID],
                                    IsDuplicate:false,
                                    OnSuccess:function(){
                                        // $.Confirm({ strContent: '<span langkey="sys_Cfm_UpdSuccess"></span>' });
                                        // Obj_FN_Main.pnMain('pnTable')
                                    }
                                })
                            }

                            if(action == 'Edit'){
                                if(arr[intRowID].strTourGUID){
                                    $.ModulePage_OrderStep1_PopUpEditService({
                                        strUserGUID: options.strUserGUID,
                                        objDetail: arr[intRowID],
                                        strCompanyPartnerGUID: '',
                                        strCompanyOwnerGUID: '',
                                        IsEditPax:false,
                                        IsDuplicate:false,
                                        OnSuccess:function(){
                                            // $.Confirm({ strContent: '<span langkey="sys_Cfm_UpdSuccess"></span>' });
                                            GetTable(IdOrClass_Pn,_obj)
                                        }
                                    })
    
                                }
                                if(arr[intRowID].strSupplierGUID){
                                    $.ModulePage_OrderStep1_PopUpEditService_Hotel({
                                        strUserGUID: options.strUserGUID,
                                        objDetail: arr[intRowID],
                                        strCompanyPartnerGUID: '',
                                        strCompanyOwnerGUID: '',
                                        IsEditRoomType: true,
                                        IsEditPax:false,
                                        IsDuplicate:false,
                                        OnSuccess:function(){
                                            // $.Confirm({ strContent: '<span langkey="sys_Cfm_UpdSuccess"></span>' });
                                            GetTable(IdOrClass_Pn,_obj)
                                        }
                                    })
                                }
                            }

                            if(action == 'EditPax'){
                                if(arr[intRowID].strTourGUID){
                                    $.ModulePage_OrderStep1_PopUpEditService({
                                        strUserGUID: options.strUserGUID,
                                        objDetail: arr[intRowID],
                                        strCompanyPartnerGUID: '',
                                        strCompanyOwnerGUID: '',
                                        IsEditPax:true,
                                        IsDuplicate:false,
                                        OnSuccess:function(){
                                            // $.Confirm({ strContent: '<span langkey="sys_Cfm_UpdSuccess"></span>' });
                                            GetTable(IdOrClass_Pn,_obj)
                                        }
                                    })
                                }
                                
                                if(arr[intRowID].strSupplierGUID && arr[intRowID].strItemTypeGUID && !arr[intRowID].strSupplierChildAgeGUID){
                                    $.ModulePage_OrderStep1_PopUpEditService_Hotel({
                                        strUserGUID: options.strUserGUID,
                                        objDetail: arr[intRowID],
                                        strCompanyPartnerGUID: '',
                                        strCompanyOwnerGUID: '',
                                        IsEditPax:true,
                                        IsDuplicate:false,
                                        OnSuccess:function(){
                                            // $.Confirm({ strContent: '<span langkey="sys_Cfm_UpdSuccess"></span>' });
                                            GetTable(IdOrClass_Pn,_obj)
                                        }
                                    })
                                }

                                if(arr[intRowID].strSupplierGUID && arr[intRowID].strSupplierChildAgeGUID){
                                    $.ModulePage_OrderStep1_PopUpEditService_Hotel({
                                        strUserGUID: options.strUserGUID,
                                        objDetail: arr[intRowID],
                                        strCompanyPartnerGUID: '',
                                        strCompanyOwnerGUID: '',
                                        IsEditPax:false,
                                        IsEditPaxChild:true,
                                        IsDuplicate:false,
                                        OnSuccess:function(){
                                            // $.Confirm({ strContent: '<span langkey="sys_Cfm_UpdSuccess"></span>' });
                                            GetTable(IdOrClass_Pn,_obj)
                                        }
                                    })
                                }

                                if(arr[intRowID].strSupplierGUID && arr[intRowID].strSurchargeDateGUID){
                                    $.ModulePage_OrderStep1_PopUpEditService_Surcharge({
                                        strUserGUID: options.strUserGUID,
                                        objDetail: arr[intRowID],
                                        strCompanyPartnerGUID: '',
                                        strCompanyOwnerGUID: '',
                                        OnSuccess:function(){
                                            // $.Confirm({ strContent: '<span langkey="sys_Cfm_UpdSuccess"></span>' });
                                            GetTable(IdOrClass_Pn,_obj)
                                        }
                                    })
                                }
                            }
                        })

                        $(_idOrClass_Pn + ' button').click(function(){
                            var intRowID = $(this).parents('tr').attr('row')
                            var action = $(this).attr('action')
    
                            if(action == 'Delete'){

                                
                                $.Confirm({
                                    strContent: '<span langkey="sys_Cfm_AYS"></span>'
                                    , OnSuccess: function () {
                                        
                                        png.postListApiGetValue({
                                            objList_Api: ObjList_Api
                                            ,objListApi_RtnVal: {
                                                'DelOrderBookingItem':{
                                                    objParams_Cus:arr[intRowID]
                                                    , OnSuccess: function(data){ 
                                                        GetTable(IdOrClass_Pn,_obj)
                                                        $.Confirm({ strContent: '<span langkey="sys_Cfm_DelSuccess"></span>' });
                                                    }
                                                }
                                            }
                                        })
        
                                    }
                                })

                            }
                        })

                    }
                    // ,changeInput:function(){}
                    ,IsViewCheckBoxMain:true
                    ,idOrClass:_idOrClass_Pn
                })
            }

            function GetTable2(_idOrClass_Pn,_obj){

                var arr2 = []//Arr_ListTbl.filter(function(item){ return item.strCompanyGUID == _obj.strCompanyGUID })
                
                pngPn.getTable2({
                    objApi: ObjList_Api.GetListPassengerOrderItem
                    ,objParams_Cus:{
                        strPassengerOrderByAgentHostGUID: _obj.strPassengerOrderByAgentHostGUID
                    }
                    ,editRltArr: function(_arr,_arrAll){

                        _arr.forEach(function(value){
                            var IsView = false
                            if(moment($.pngFormatDateTime(value.dtmDateFrom,'l')).diff(moment(), 'days') < 0 ){
                                    IsView = true
                            }
                            if(!(value.intRemain == null || (value.intRemain && value.intQuantity && value.intQuantity < value.intRemain)) ){
                                IsView = true
                            }

                            if(value.intLevel == 2){
                                if(arr2.filter(function(item){ return (item.strPassengerOrderItemGUID || '').toUpperCase() == (value.strParentPassengerOrderItemGUID || '').toUpperCase() }).length)
                                    IsView = true
                            }
                            if(IsView)
                            arr2.push(value)
                        })

                        arr2.forEach(function(value){
                            if(value.IsMaster){
                                var arrItem =  arr2.filter(function(item){ return (item.strSupplierGUID || '').toUpperCase() == value.strSupplierGUID.toUpperCase() && !item.IsMaster })
                               
                                if(arrItem.length){
                                    
                                    var dblPriceTotalAgentCom = 0
                                    var dblPriceTotal = 0

                                    arrItem.forEach(function(val){
                                        dblPriceTotalAgentCom+= (val.dblPriceTotalAgentCom || 0)
                                        dblPriceTotal+= (val.dblPriceTotal || 0)
                                    })
                                    value.dblPriceTotalAgentCom = dblPriceTotalAgentCom
                                    value.dblPriceTotal = dblPriceTotal
                                    

                                }else{
                                    value.IsNotView = 1
                                }
                            }
                        })

                        arr2 = arr2.filter(function(item){ return !item.IsNotView })
                        // arr = _arr                     
                        Arr_ListTbl_2 = Arr_ListTbl_2.concat(arr2);

                        // arr = Arr_ListTbl.filter(function(item){ return item.strCompanyGUID.toUpperCase() == _obj.strCompanyGUID.toUpperCase() })
                        return arr2
                    }
                    ,editRlt: function(value,key){
                        value['No'] = (key+1)
                        // value['strIsPassengerBooked_View'] = (value['IsPassengerBooked']?1:0)
                        
                        // value['strGroupName_View'] = (value['strGroupName'] || '')+(value['IsPassengerBooked']? '<div><i>(Book from Traveller)</i></div>':'')
                        
                        if(value.strTourGUID)
                            value['strServiceName_View'] = '<a href="?menuid=1b7a2657-18eb-4703-8573-fa43b8dda001&module=detail&idmdit='+value.strTourGUID+'">'+value['strServiceName']+'</a>'
                        else if(value.strSupplierGUID)
                            value['strServiceName_View'] = '<a href="?menuid=2b7a2657-18eb-4703-8573-fa43b8dda001&module=detail&idmdit='+value.strSupplierGUID+'">'+value['strServiceName']+'</a>'
                        else
                            value['strServiceName_View'] = value['strServiceName']

                        if(!value.IsMaster)
                            value['strServiceName_View']+= '<div>'+ $.pngFormatDateTime(value.dtmDateFrom) + ' - ' + $.pngFormatDateTime(value.dtmDateTo)+'</div>'
                        
                        var intMar = 0
                        if(value.intLevel == 1)
                            intMar = '15px'
                        
                        if(value.intLevel == 2)
                            intMar = '30px'

                        value['strServiceName_View'] = '<div style="margin-left: '+intMar+'">'+value['strServiceName_View']+'</div>'
                        
                        value['strDtmDateFromDateTo'] = $.pngFormatDateTime(value.dtmDateFrom) + ' - ' + $.pngFormatDateTime(value.dtmDateTo)
                        value['dblPriceTotal_View'] = '<a action="PriceDetail">'+$.pngFormatPrice(value.dblPriceTotal)+'</a>'
                        
                        value.IsShowCheckbox= false
                        if(value.strTourGUID){
                            value.IsShowCheckbox = true
                        }
                        if(value.strSupplierGUID && (value.strItemTypeGUID || value.IsMaster)){
                            value.IsShowCheckbox = true
                        }



                        if(value.dblPriceAgentComUnit == null)
                            value.dblPriceTotalAgentCom = null
                        if(value.dblPriceTotalAgentCom==null)
                            value['dblTotalCommission_View'] = 'N/A'
                        else
                            value['dblTotalCommission_View'] = $.pngFormatPrice(value.dblPriceTotalAgentCom)
                    
                        if(!value['IsMaster'])
                            value['intTotalPax_View'] = '<a action="EditPax">'+value['intQuantity']+'</a>'
                        else
                            value['intTotalPax_View'] = ''

                        if(value.intRemain != null){
                            if(value.strTourGUID){
                                value['intTotalPax_View']+= ' (<i class="fa fa-male"></i> '+value.intAdultsInService+' - <i class="fa fa-child"></i> '+(value.intChildren || 0 )+')'
                                value['intTotalPax_View']+= '<div>(Số chỗ còn lại: '+value.intRemain+')</div>'
                            }
                            if(value.strItemTypeGUID)
                                value['intTotalPax_View']+= '<div>(Available: '+value.intRemain+')</div>'
                        }
                            
                            
                            
                        value['strType_View'] = value['strType']//+'<a action="Edit">Chỉnh sửa</a>'
                        // var strUrl = coreLoadPage.getUrlHost()
                        // strUrl = $.pngGetQSVal('cname', $.pngGetQSVal('cname'),strUrl)
                        // strUrl = $.pngGetQSVal('page', 'order',strUrl)
                        // strUrl = $.pngGetQSVal('GUID', value.strOrderBookingGUID,strUrl)
                        value['strHtmlAction'] = ''
                        if(value.IsShowCheckbox)
                            value['strHtmlAction']+= '<button class="btn" action="Delete" intRowID="' + key + '"><i class="fa fa-trash"></i></button>'
                        
                    }
                    ,objCols: {
                        
                        No: { name: '<span langkey="sys_Txt_No"></span>' },
                        strServiceName_View: { name: 'Service name' },
                        strType_View: { name: 'Type' },
                        intTotalPax_View:{name:'Quantity',strAttrTD:' style="text-align:right"'},
                        dblPriceTotal_View:{name:'Total price',strAttrTD:' style="text-align:right"'},
                        dblTotalCommission_View:{name:'Total commission',strAttrTD:' style="text-align:right"'},
                        strHtmlAction: { name: '<span langkey="sys_Txt_Action"></span>' },
                    }
                    // ,editTableInput:function(){}
                    , changeCkbMaster: function (IsChecked, intRowID,arrList) {
    
    
                        // arr = arrList
                    }
                    ,customEvent: function(_idOrClass_Pn){

                        $(_idOrClass_Pn + ' a').click(function(){
                            var intRowID = $(this).parents('tr').attr('row')
                            var action = $(this).attr('action')
    
                            if(action == 'PriceDetail'){
                                GetPopUp_PriceDetail({
                                    objDetail: arr2[intRowID],
                                    IsDuplicate:false,
                                    OnSuccess:function(){
                                        // $.Confirm({ strContent: '<span langkey="sys_Cfm_UpdSuccess"></span>' });
                                        // Obj_FN_Main.pnMain('pnTable')
                                    }
                                })
                            }
                        })
    
                        $(_idOrClass_Pn + ' button').click(function(){
                            var intRowID = $(this).parents('tr').attr('row')
                            var action = $(this).attr('action')
    
                            if(action == 'Delete'){

                                
                                $.Confirm({
                                    strContent: '<span langkey="sys_Cfm_AYS"></span>'
                                    , OnSuccess: function () {
                                        
                                        png.postListApiGetValue({
                                            objList_Api: ObjList_Api
                                            ,objListApi_RtnVal: {
                                                'DelOrderBookingItem':{
                                                    objParams_Cus:arr2[intRowID]
                                                    , OnSuccess: function(data){ 
                                                        GetTable2(_idOrClass_Pn,_obj)
                                                        $.Confirm({ strContent: '<span langkey="sys_Cfm_DelSuccess"></span>' });
                                                    }
                                                }
                                            }
                                        })
        
                                    }
                                })

                            }
                        })

                    }
                    // ,changeInput:function(){}
                    ,IsViewCheckBoxMain:false
                    ,idOrClass:_idOrClass_Pn
                })
            }
        }

        
        pngPn.getPanelHtml({            // Get ra panel dạng html
            objPanel: objPanel
            ,objEvtPanel: objEvtPanel
            ,idOrClass: IdOrClass_Main  // Id or class chính
            ,OnChangeIdPn: function(_Fn){
                Obj_FN_Main.pnMain = _Fn    // Hàm đổi trang
            }   
        })

    }


    
    function GetPopUp_PriceDetail(_Opt){
        var Dft = {
            objDetail: {},
            IsDuplicate:null,
            OnSuccess: function () {
    
            }
        }
        _Opt = $.extend(Dft, _Opt);

        console.log('Function',_Opt)
        
        var IdOrClass_Main = ''

        var Is_Create = false
        var Is_Edit = false
        var Is_Duplicate = false

        var Obj_Detail = _Opt.objDetail
        // var Obj_Detail = options.objDetail

        //---------Obj_XXX      // Khai báo các biến dùng chung cho cả hàm
        //---------Arr_XXX
        //---------Is_XXX
        //---------Int_XXX
        //---------Str_XXX
        

        // if(Object.keys(Obj_Detail).length){
        //     Is_Edit = true
        // }else{
        //     Is_Create = true
        // }
        // if(_Opt.IsDuplicate){
        //     Is_Edit = false
        //     Is_Duplicate = true
        // }

        //------------------- Khái báo biển chính của giao diện
        var Obj_Filter_Dtl = {}
        var Obj_Filter = {}
        var Arr_ListTbl = []
        var ArrPriceTable = []

        var Obj_FormInput = {}

        var Obj_FN_Main = {}
        //-------------------
        

        png.postListApiGetValue({           // Post list các Api phía trên và lấy về dữ liệu
            objList_Api: ObjList_Api            // Tên các Object api đã khai báo phía trên 
            // ,objList_ComboValue: ObjList_ComboValue // Tên các Object api dropdownlist đã khai báo phía trên 
            ,objListApi_RtnVal: {           // Giá trị nhận về từ API
                'GetListPassengerOrderItem':{               // Tên api tương ứng với giá trị trả về
                    objParams_Cus:{
                        strPassengerOrderItemGUID: Obj_Detail.strPassengerOrderItemGUID,
                        strPassengerOrderByAgentHostGUID: null,
                        tblsReturn:'[1]'
                    }
                    ,OnSuccess: function(data){
                        Arr_ListTbl = JSON.parse(data)[1]   // Dữ liệu trả về từ api trên
                        console.log(Arr_ListTbl)
                    }
                }
            }
            // ,objListComboValue_RtnVal: {    // Giá trị nhận về từ dropdownlist
            //     'Arr_SQL':{
            //         objParams_Cus:{
    
            //         }, 
            //         OnSuccess: function(data){ 
            //             // Arr_LangDdl = data   // Dữ liệu trả về từ dropdownlist trên
            //         }
            //     }
            // }
            ,OnSuccessList:function(data){      // Hàm thực hiện khi thành công tất cả các api trên
                GetPopUp()
            }
        })
        // GetPopUp()
        function GetPopUp(){
            var strTitle = 'Price Detail'
            // if(Is_Create){
            //     strTitle = pngElm.getLangKey({langkey:'sys_Btn_Create'})
            // }
            
            // if(Is_Edit){
            //     strTitle = pngElm.getLangKey({langkey:'sys_Btn_Edit'})
            // }
            // if(Is_Duplicate){
            //     strTitle = pngElm.getLangKey({langkey:'sys_Btn_Duplicate'})
            // }
            pngPn.getPopUp({
                strTitle: strTitle
                , intTypeSize:2//------------1 small ---2 medium ---3 large
                , OnPanel: GetMainPanel
                , OnClosePopUp: function () {
                    //------Chọn sự kiện khi Đóng PopUP
                    // options.OnSuccess.call()
                    // _Opt.OnSuccess.call()
                }
            })
        }
    
        function GetMainPanel(_IdOrClassPp,_OnClosePp){
    
            IdOrClass_Main = _IdOrClassPp
            Obj_FN_Main.OnClosePp = _OnClosePp
    
            //Obj_FN_Main.OnClosePp(true)----------- chạy câu lệnh trong OnClosePopUp: function (){} khi tắt PopUp
            //Obj_FN_Main.OnClosePp(true,true)-----------Đóng Pop Up + chạy câu lệnh trong OnClosePopUp: function (){}
    
    
            var objPanel = {
                pnMain:{tag:'div',attr:'class=""'
                        ,childTags:[{div:'class="row"'}]
                    // ,pnListBtn:{tag:'div',attr:'class="col-md-12"'} 
                    // ,pnFormFilter:{tag:'div',attr:'class="col-md-12"'}
                    ,pnTable:{tag:'div',attr:'class="col-md-12"'}
                    
                    // ,pnForm:{tag:'div',attr:'class="col-md-12"'}
                    // ,pnBtn:{tag:'div',attr:'class="col-md-12"'}
                }
            }
            var objEvtPanel = {}
            
            objEvtPanel.pnTable = function(_idOrClassPn){
                var IdOrClass_Pn = _idOrClassPn
                
                var intRowIDTour = 0
                var strPassengerOrderItemGUID = ''
                Arr_ListTbl.forEach(function(value2,key2){
        
                    // if(value2.intCateID == 18 || value2.intCateID == 19 || value2.intCateID == 33)
                        if(value2.intQuantity){
                            // if(value2.intQuantityTypeID == 1){
                                intRowIDTour++
                                var objBookingItem = $.pngExtendObj(value2,{
                                    'No':intRowIDTour,
                                    strBookingServiceName:value2.strServiceName,
                                    strBookingDateFrom: $.pngFormatDateTime(value2.dtmDateFrom),
                                    strBookingDateTo: $.pngFormatDateTime(value2.dtmDateTo),
                                    intTotalPax: value2.intQuantity,
                                    strDtmDateFreeCancellation: $.pngFormatDateTime(value2.strDtmDateFreeCancellation),
                                    dblPriceUnit: value2.intUnitPrice,
                                    dblPriceUnitView: $.pngFormatPrice (value2.intUnitPrice),
                                    dblPriceTotal: value2.dblPriceTotal,
                                    dblPriceTotalView: $.pngFormatPrice (value2.dblPriceTotal),
                                    dblPriceAgentComUnit: value2.dblPriceAgentComUnit,
                                    dblPriceTotalAgentCom: value2.dblPriceTotalAgentCom,
                                    IsEnable: value2.IsEnable,
                                    IsMainService: true,
                                    
                                    strHtmlAction: '<button class="btnDelete btn " intRowID="' + key2 + '" style="background: #ECEDEE;"><i class="fa fa-trash"></i></button>',
                                })
            
                                if(value2.intCateID == 18 || value2.intCateID == 19 || value2.intCateID == 33){
                                    if(value2.strPassengerOrderItemGUID != strPassengerOrderItemGUID){
                                        strPassengerOrderItemGUID = value2.strPassengerOrderItemGUID
                                    }else{
                                        objBookingItem.strBookingServiceName = '- '+objBookingItem.strBookingServiceName
                                        objBookingItem.strBookingDateFrom = null
                                        objBookingItem.strBookingDateTo = null
                                        objBookingItem.strDtmDateFreeCancellation = null
                                        objBookingItem.IsMainService = false
                                        objBookingItem['strHtmlAction'] = null
                                    }
                                }
                                if(value2.intCateID == 1 || value2.intCateID == 31 || value2.intCateID == 34){
                                        
                                    if(!value2.strFocGUID){
                                        if(value2.strPassengerOrderItemGUID != strPassengerOrderItemGUID){
                                            strPassengerOrderItemGUID = value2.strPassengerOrderItemGUID
                                            objBookingItem.strBookingServiceName = value2.strSupplierName+' - '+value2.strItemTypeName+' - '+objBookingItem.strBookingServiceName
                                        }else{
                                            objBookingItem.strBookingServiceName = '- '+objBookingItem.strBookingServiceName
                                            objBookingItem.strBookingDateFrom = null
                                            objBookingItem.strBookingDateTo = null
                                            objBookingItem.strDtmDateFreeCancellation = null
                                            objBookingItem.IsMainService = false
                                            objBookingItem['strHtmlAction'] = null
                                        }
                                    }
                                    else{
                                        if(value2.strPassengerOrderItemGUID != strPassengerOrderItemGUID){
                                            strPassengerOrderItemGUID = value2.strPassengerOrderItemGUID
                                            objBookingItem.strBookingServiceName = value2.strSupplierName+' - '+objBookingItem.strBookingServiceName
                                        }else{
                                            objBookingItem.strBookingServiceName = '- '+objBookingItem.strBookingServiceName
                                            objBookingItem.strBookingDateFrom = null
                                            objBookingItem.strBookingDateTo = null
                                            objBookingItem.strDtmDateFreeCancellation = null
                                        }
                                        
                                        objBookingItem.IsMainService = false
                                        objBookingItem['strHtmlAction'] = null
                                    }
                                }
            
                                if(objBookingItem.strBookingDateFrom)
                                    objBookingItem['dtmDateFromTo_View'] = objBookingItem.strBookingDateFrom + ' - '+ objBookingItem.strBookingDateTo
            
                                objBookingItem = $.pngExtendObj(value2,objBookingItem)
                                ArrPriceTable.push(objBookingItem)
                        }


            
                })

                var objCols = {'No':{name:'<span langkey="sys_Txt_Tbl-No"></span>'}
                    ,strServiceName_View: {name:'<span langkey="pg_Dft_TC_OrDtl_ServiceName"></span>'}
                    // ,strDtmDateFreeCancellation: {name: pngElm.getLangKey({langkey:'pg_Dft_TC_OrDtl_FreeCancellationTill'})}
                    ,dtmDateFromTo_View: {name:'<span langkey="pg_Dft_TC_OrDtl_DateFrom"></span> - <span langkey="pg_Dft_TC_OrDtl_DateTo"></span>'}
                    // ,strBookingDateTo: {name:''}
                    ,intTotalPax_View: {name:'<span langkey="pg_Dft_TC_OrDtl_TotalPax"></span>', strAttrTD:'style="text-align:right"'}
                    ,dblPriceUnitView: {name:'<span langkey="pg_Dft_TC_OrDtl_PriceUnit"></span>', strAttrTD:'style="text-align:right"'}
                    ,dblPriceTotalView: {name:'<span langkey="pg_Dft_TC_OrDtl_PriceTotal"></span>', strAttrTD:'style="text-align:right"'}
                }

                if ($(window).width() < 767){
                    objCols = {'No':{name:'<span langkey="sys_Txt_Tbl-No"></span>'}
                        
                        ,strServiceName_View :{name:'<span langkey="pg_Dft_TC_OrDtl_ServiceName"></span>', strAttrTD: "style='vertical-align: top' "
                            ,list_input:{
                                        
                                strServiceName_View:{title:'',attr:"class='col-md-12' "
                                    ,input:{IsNoInput:true,IsViewDtl:true}
                                },   
                                dtmDateFromTo_View:{title:'',attr:"class='col-md-12' style='margin-bottom:5px"
                                    ,input:{IsNoInput:true,IsViewDtl:true}
                                },
                                
                            }
                        }
                        ,dblPriceUnitView :{name:'<span langkey="pg_Dft_TC_OrDtl_PriceUnit"></span>',strAttrTD:'style="vertical-align:top"'
                            ,list_input:{
                                dblPriceUnitView:{title:'',attr:"class='col-md-12'"
                                    ,input:{IsNoInput:true,IsViewDtl:true}
                                },
                                intTotalPax_View:{title:'<span langkey="pg_Dft_TC_OrDtl_TotalPax"></span>',attr:"class='col-md-12' style='margin-bottom:5px'"
                                    ,input:{IsNoInput:true,IsViewDtl:true}
                                },
                                dblPriceTotalView:{title:'<span langkey="pg_Dft_TC_OrDtl_PriceTotal"></span>',attr:"class='col-md-12' style='margin-bottom:5px'"
                                    ,input:{IsNoInput:true,IsViewDtl:true}
                                },
                            }
                        }
                    }
        
                }
                

                pngPn.getTable2({
                    objApi:null
                    ,objParams_Cus:null
                    ,editRltArr: function(arr){
                        return ArrPriceTable
                    }
                    ,editRlt: function(value,key){
                        value['No'] = (key+1)
                        
                        value.intTotalPax_View = value.intTotalPax
                        if(value['IsEnable']){
                            value.intTotalPax_View = value.intTotalPax
                        }
                        // valTbl['strHtmlAction']= '<button class="btnDelete btn btn-danger" data="' + keyTbl + '"><i class="fa fa-trash"></i></button>'

                        var IsRoom = false
                        if((value.intQuantityTypeID >= 5 && value.intQuantityTypeID <= 8) || (value.intQuantityTypeID >= 18 && value.intQuantityTypeID <= 25))
                            IsRoom = true
                        
                        value['strServiceName_View'] = value['strBookingServiceName']+(value['intProductID'] == 2 && IsRoom? ' <b>(Giá GIT)</b>' : '')
                        
                        if(value['strPriceListGUID'] && value['IsSystemPriceList'] != 1 && !value['strFocGUID'] && IsRoom){
                            value['strServiceName_View']+='<br><i>('+ value['strPriceListName']+')</i>'
                        }
                        
                        if(value['strTourGUID']){
                            if(value['IsEnable'])
                                value['strServiceName_View'] = '<a action="ViewTourDetail" intRowID="'+key+'">'+value['strBookingServiceName']+'</a>'
                            else
                                value['strServiceName_View']+='<br><b>(Tour của bạn không thể Book được)</b>'
                        }
                    }
                    ,objCols: objCols
                    // ,editTableInput:function(){}
                    , changeCkbMaster: function (IsChecked, intRowID,arrList) {
                        
        
                        ArrPriceTable = arrList
                    }
                    ,customEvent: function(_idOrClassPn){

        
                    }
                    // ,changeInput:function(){}
                    ,IsViewCheckBoxMain:false
                    ,idOrClass:IdOrClass_Pn
                })
    
            }
            // ===================================
            
            pngPn.getPanelHtml({            // Get ra panel dạng html
                objPanel: objPanel
                ,objEvtPanel: objEvtPanel
                ,idOrClass: IdOrClass_Main  // Id or class chính
                ,OnChangeIdPn: function(_Fn){
                    Obj_FN_Main.pnMain = _Fn    // Hàm đổi trang
                }   
            })
            
            
    
        }
    }


    
}


$.ModulePage_OrderStep1_PopUpEditService = function (options) {
    var defaults = {
        strUserGUID: ''
        ,strCompanyPartnerGUID: ''
        ,strCompanyOwnerGUID: ''
        ,objDetail: {}
        ,IsEditPax: null
        ,OnSuccess: function () {
        }
    }
    options = $.extend(defaults, options);


    var IdOrClass_Main = ''

    
    //---------Obj_XXX
    //---------Arr_XXX
    //---------Is_XXX
    //---------Int_XXX
    //---------Str_XXX
    
    var Obj_Detail = options.objDetail

    var Str_ListChildAge = ''

    var arr = (Obj_Detail.strListChildAge || '').split('#')

    arr.forEach(function(value){
        var arr2 = value.split('!')
        for(var i = 0; i < arr2[1];i++){
            Str_ListChildAge+=arr2[0]+','
        }
    })

    Str_ListChildAge = (Str_ListChildAge+'|').replace(/,\|/g,'').replace(/\|/g,'')

    var ObjList_Api = {
        GetListTourDetailByPtn:{
            strApiLink:'api/tour/GetListTourDetailByPtn'
            ,objParams:{
                strUserGUID: options.strUserGUID
                , strTourGUID: Obj_Detail.strTourGUID

                , intCurPage: 1
                , intPageSize: 1
                , strOrder: null
                , tblsReturn:'[0]'
            }
        },

        GetListPriceItemTourByPUB:{
            strApiLink:'api/public/traveller/GetListPriceItemTourByPUB'
            ,objParams:{

                strUserGUID: options.strUserGUID
                , strTourPriceItemGUID: null
                , strTourGUID: null
                //, strPriceLevelGUID: null//options.objTourDetail.strPriceLevelGUID
                , intNoOfAdult: null    
                , xmlNoOfChild: null
                , intNoOfSGLSup: null
                , intNoOfTPLRec: null

                , dtmFilterDateFrom: null
                , dtmFilterDateTo: null

                ,strCompanyOwnerGUID: null
                ,IsHasPriceKid: null
                ,intEasiaCateID: null
                ,intCateID: null
                ,intJoinTypeID:null
                ,intTransportOptionID:null
                ,intCurPage:1
                ,intPageSize:1
                ,strOrder:null
                ,tblsReturn:'[0]'

            }
        },
        
        GetListPaxBookingTourForBkByPUB:{
            strApiLink:'api/tour/GetListPaxBookingTourForBkByPUB'
            ,objParams:{
                strUserGUID : options.strUserGUID
                ,strCompanyOwnerGUID : null
                ,strTourGUID : null
                ,strPaxBookingTourCode: null
                ,intEasiaCateID : null
                ,intTransportOptionID : null
                ,intNoOfAdult : null
                ,strListNoOfChild : null
                ,intNoOfSGLSup : null
                ,intNoOfTPLRec : null
                ,IsHasPriceKid : null
                ,dtmDateValidFrom: null
                ,dtmDateValidTo: null

                ,intCurPage : null
                ,intPageSize : null
                ,strOrder : null
                ,tblsReturn : '[0]'
            }
        },
        UpdOrderBookingItemForTour:{
            strApiLink:'api/booking/UpdOrderBookingItemForTour'
            ,objParams:{
                strUserGUID : options.strUserGUID,
                strOrderBookingItemGUID: Obj_Detail.strPassengerOrderItemGUID,
                strTourPriceItemLevelGUID: null,
                strDepartureTourLevelGUID: null,
                intAdult: null,
	            strListChildAge: null,
                intMemberTypeID: 5,
            }
        }
    }

    var ObjList_ComboValue = {
        ArrCateTour_Ddl:{
            strCombocode:'012'             // Mã code
        }
        
        ,ArrJoinType_Ddl:{
            strTableName:'BT05'             // Bảng sử dụng để get dữ liệu
            ,strFeildSelect:'BT05_JoinTypeID AS intID,BT05_JoinTypeName AS strName' // Trường cần lựa chọn
            ,strWhere:'WHERE IsActive = 1 ORDER BY BT05_Order'      // Điều kiện
            ,IsNotCache:0
        }
        
        ,ArrTransportOption_Ddl:{
            strTableName:'CM40'             // Bảng sử dụng để get dữ liệu
            ,strFeildSelect:'CM40_TransportOptionID AS intID,CM40_TransportOptionName AS strName' // Trường cần lựa chọn
            ,strWhere:'WHERE IsActive = 1 ORDER BY CM40_TransportOptionName'      // Điều kiện
            ,IsNotCache:0
        }
    }

    var Arr_OrderPaymentTerm = []
    var Arr_PaymentMethod = []
    var Obj_Payment = {}

    var Arr_Salute_Ddl = []
    var Arr_Country_Ddl = []
    var Arr_Age_Ddl = []

    //---------
    var Obj_FormInput = {}
    var Obj_FN_Main = {}
    //---------

    var Str_TourPriceItemLevelGUID = null
    var Str_DepartureTourLevelGUID = null
    var Str_PaxDailyBookingTourCode = ''
    var Str_PaxBookingTourCode = ''
    // Arr_ListService.forEach(function(value){
    //     strListOrderBookingItemGUID+=value.strPassengerOrderItemGUID+','
    // })

    png.postListApiGetValue({
        objList_Api: ObjList_Api
        ,objList_ComboValue: ObjList_ComboValue
        ,objListApi_RtnVal: {           // Giá trị nhận về từ API
            'GetListTourDetailByPtn':{               // Tên api tương ứng với giá trị trả về
                objParams_Cus:{
                }
                ,OnSuccess: function(data){
                    // return JSON.parse(data)[0]   // Dữ liệu trả về từ api trên
                    var obj =  JSON.parse(data)[0][0]

                    delete obj.dtmDateFrom
                    delete obj.dtmDateTo
                    delete obj.intEasiaCateID
                    delete obj.intJoinTypeID
                    delete obj.intTransportOptionID
                    

                    Obj_Detail = $.pngExtendObj(Obj_Detail,obj)
                }
            }
        }
        ,objListComboValue_RtnVal: {
            'ArrCateTour_Ddl':{
                objParams_Cus:{}, 
                OnSuccess: function(data){ 
                    ArrCateTour_Ddl = data   // Dữ liệu trả về từ dropdownlist trên
                }
            },
            
            'ArrJoinType_Ddl':{
                objParams_Cus:{}, OnSuccess: function(data){ 
                    ArrJoinType_Ddl = $.pngGetArrComboValue(data,'intID','strName')
                }
            }
            ,'ArrJoinType_Ddl':{
                objParams_Cus:{}, OnSuccess: function(data){ 
                    ArrJoinType_Ddl = $.pngGetArrComboValue(data,'intID','strName')
                }
            }
            ,'ArrTransportOption_Ddl':{
                objParams_Cus:{}, OnSuccess: function(data){ 
                    ArrTransportOption_Ddl = $.pngGetArrComboValue(data,'intID','strName')
                }
            }
        }
        ,OnSuccessList:function(data){

                GetPopUp()
            
        }
    })

    // GetPopUp()
    function GetPopUp(){
        pngPn.getPopUp({
            strTitle: 'Payment'
            , intTypeSize:1//------------1 small ---2 medium ---3 large
            , OnPanel: GetMainPanel
            , OnClosePopUp: function () {
                //------Chọn sự kiện khi Đóng PopUP
            }
        })
    }

    function GetMainPanel(_IdOrClassPp,_OnClosePp){

        IdOrClass_Main = _IdOrClassPp
        Obj_FN_Main.OnClosePp = _OnClosePp

        // Obj_FN_Main.OnClosePp(true)----------- chạy câu lệnh trong OnClosePopUp: function (){} khi tắt PopUp
        // Obj_FN_Main.OnClosePp(true,true)-----------Đóng Pop Up + chạy câu lệnh trong OnClosePopUp: function (){}

        var objPanel= {
            pnMain:{tag:'div',attr:'class=""',childTags:[{div:'class="row"'}]
                ,pnContent:{tag:'div',attr:'class="col-md-12"'}
                ,pnBtn:{tag:'div',attr:'class="col-md-12" '}
            }
        }

        var objEvtPanel = {}
        objEvtPanel.pnContent = function(_idOrClassPn){
            var IdOrClass_Pn = _idOrClassPn

            var strHtml = ''
            strHtml+= '         <div ìd="col-md-12" id="pnForm"></div>'
            strHtml+= '         <div ìd="col-md-12" id="pnPriceTotal" style="padding: 0 0 10px;margin-bottom: 15px;"></div>'

            $(IdOrClass_Pn).html(strHtml)

            GetForm(IdOrClass_Pn + ' #pnForm',false)
        
            function GetForm(_idOrClassPn,_IsMobile){
                var ArrCateTour_Ddl_2 = []
            
                ArrCateTour_Ddl.forEach(function(value){
                    Obj_Detail.strListEasiaCateID.split(',').forEach(function(value2){
                        if(Object.keys(value)[0] == value2)
                            ArrCateTour_Ddl_2.push(value)
                    })
                })


                var ArrJoinType_Ddl_2 = []

                ArrJoinType_Ddl.forEach(function(value){
                    Obj_Detail.strListJoinTypeID.split(',').forEach(function(value2){
                        if(Object.keys(value)[0] == value2)
                            ArrJoinType_Ddl_2.push(value)
                    })
                })

                var ArrTransportOption_Ddl_2 = []

                ArrTransportOption_Ddl.forEach(function(value){
                    Obj_Detail.strListTransportOptionID.split(',').forEach(function(value2){
                        if(Object.keys(value)[0] == value2)
                            ArrTransportOption_Ddl_2.push(value)
                    })
                })

                

                var objInput = {
                    pnAgeAndRoom:{title:'',attr:"class='col-md-12'"
                        ,input:{IsNoInput:true}
                    },
                    intEasiaCateID:{title:'<span langkey="pg_Main_Tour_MdDtl_CategoryTour"></span>',attr:"class='col-md-12'",isRequire:false,IsRtn:true
                        ,input:{type:'select',classEx:'form-control',attr:''}
                        ,dropDown:{arrList: ArrCateTour_Ddl_2}
                    }
                }
                
                if(Obj_Detail.intTourTypeID == 19){

                    // if(ArrCateTour_Ddl_2.length = 1)
                    //     delete objInput['intEasiaCateID'] 
                    objInput['intEasiaCateID'].attr = "class='col-md-6'"
                    objInput['intJoinTypeID'] = {title:'Join Type',attr:"class='col-md-6'",isRequire:false,IsRtn:true
                        ,input:{type:'select',classEx:'form-control',attr:''}
                        ,dropDown:{arrList:ArrJoinType_Ddl_2}
                    }
                }

                if(ArrTransportOption_Ddl_2.length){
                    objInput.intTransportOptionID = {title:'Transport',attr:"class='col-md-12'",isRequire:false,IsRtn:true
                        ,input:{type:'select',classEx:'form-control',attr:''}
                        ,dropDown:{arrList: ArrTransportOption_Ddl_2}
                    }
                }

                // if(options.objTourDetail.intTourTypeID == 21){
                //     objInput['dtmDateStart'] = {title:pngElm.getLangKey({langkey:'pg_Main_Tour_PPbook-DateStart'}),attr:"class='col-md-12'"
                //         ,input:{IsNoInput:true} 
                //     }
                // }

                pngPn.getForm({
                    action: 1,
                    objInput: objInput,
                    idOrClass: _idOrClassPn,
                    objDetail: $.pngExtendObj(Obj_Detail,{
                        // dtmDateStart: ObjSearchDtl.dtmDateStart
                    })
                })

                if(options.IsEditPax){
                    $('.pnElm-pnAgeAndRoom',_idOrClassPn).parent().show()
                    $('.intEasiaCateID,.intJoinTypeID,.intTransportOptionID',_idOrClassPn).parent().hide()
                }else{
                    $('.pnElm-pnAgeAndRoom',_idOrClassPn).parent().hide()
                    $('.intEasiaCateID,.intJoinTypeID,.intTransportOptionID',_idOrClassPn).parent().show()
                }
                    
                GetMain_GetAgeAndRoom(_idOrClassPn+' .pnElm-pnAgeAndRoom',function(){
                    
                    GetMain_GetFormMain()
                })
                    
                $( _idOrClassPn+' select').change( function() {
                    GetMain_GetFormMain()
                });

        
                GetMain_GetFormMain() 
                function GetMain_GetFormMain(){

                        

                    if( Obj_Detail.intTourTypeID == 19){
                        GetMain_GetFormMain_SetTour()
                    }
                    else if( Obj_Detail.intTourTypeID == 21){
                        GetMain_GetFormMain_SetTourFix()
                    }
                    else if( Obj_Detail.intTourTypeID == 11){
                        GetMain_GetFormMain_Tarrif()
                    }
                }

                            
                function GetMain_GetFormMain_SetTour(){
                    

                    var ObjForm =pngPn.getForm({
                        action: 2,
                        objInput: objInput,
                        idOrClass: _idOrClassPn
                    })

                    ObjForm = $.pngExtendObj(Obj_Detail,ObjForm)

                    // var idOrClassPn = idOrClass+' #pnPriceTotal'
                    var xmlNoOfChild = ''
                    var arr = Str_ListChildAge.split(',')
                    arr.forEach(function(value){
                        xmlNoOfChild+='<child>'+value+'</child>'
                    })
                    // ObjSearchDtl.arrChildren.forEach(function(value){
                    //     xmlNoOfChild+='<child>'+value+'</child>'
                    // })

                    png.postListApiGetValue({           // Post list các Api phía trên và lấy về dữ liệu
                        objList_Api: ObjList_Api            // Tên các Object api đã khai báo phía trên 
                        // ,objList_ComboValue: ObjList_ComboValue // Tên các Object api dropdownlist đã khai báo phía trên 
                        ,objListApi_RtnVal: {           // Giá trị nhận về từ API
                            'GetListPriceItemTourByPUB':{               // Tên api tương ứng với giá trị trả về
                                objParams_Cus:{
                                     strTourGUID: Obj_Detail.strTourGUID
                                    ,strPriceLevelGUID: Obj_Detail.strPriceLevelGUID
                                    ,intNoOfAdult: Obj_Detail.intAdults
                                    ,xmlNoOfChild: xmlNoOfChild
                                    ,intNoOfSGLSup: Obj_Detail.intSGL
                                    ,intNoOfTPLRec: Obj_Detail.intTPL
                    
                                    ,dtmFilterDateFrom: $.pngFormatDateTime(Obj_Detail.dtmDateFrom,'l')
                                    ,dtmFilterDateTo: null
                    
                                    ,strCompanyOwnerGUID: Obj_Detail.strCompanyGUID
                                    ,IsHasPriceKid: Obj_Detail.IsHasPriceKid
                                    ,intEasiaCateID: ObjForm.intEasiaCateID
                                    ,intCateID: Obj_Detail.intCateID
                                    ,intJoinTypeID:ObjForm.intJoinTypeID
                                    ,intTransportOptionID: ObjForm.intTransportOptionID
                                }
                                ,OnSuccess: function(data){

                                    var arr = JSON.parse(data)[0]
                                    if(arr.length){
                                        if(!arr[0]['IsNotAvailable']){

                                            // options.changeDate(DtmDateStart,ArrAllList[0][0]['dblTotalPrice'])
        
                                            GetMain_GetFormMain_GetTotalPrice(arr[0]['dblTotalPrice'],arr[0]['dblTotalPriceCom'],null,arr[0]['dblOldTotalPrice'])
                                            // $('#pnPriceTotal').html('<b>Total Price:</b> '+ $.pngFormatPrice(arr[0]['dblTotalPrice']) )
                                            if(ObjForm.intJoinTypeID == 1)
                                                $('#pnPriceTotal').append('<div style="color:#F7904D;font-weight:bold">Remain: '+ $.pngFormatNumber(arr[0]['intPaxRemain'])+' Pax</div>' )
                    
                    
                                            Str_TourPriceItemLevelGUID = arr[0].strTourPriceItemGUID
                                            // Str_PaxDailyBookingTourCode =  arr[0].strPaxDailyBookingTourCode
                                            
                                            // $(idOrClass + ' #btnBook').attr('disabled',false)
                    
                                            if(ObjForm.intJoinTypeID == 2 || arr[0]['intPaxRemain'] >= Obj_Detail.intTotalPax ){
                                                ShowBtnSendEq(false)
                                            }else{
                                                ShowBtnSendEq(true)
                                            }
                                            
                                            function ShowBtnSendEq(IsShow){
                                                if(IsShow){
                                                    // $(idOrClass).find('#btnBook,#btnAddToCart').hide()
                                                    // $(idOrClass).find('#btnRequest').show()
                                                    $(IdOrClass_Main + ' #btnSave').hide()
                                                }else{
                                                    $(IdOrClass_Main + ' #btnSave').show()
                                                    // $(idOrClass).find('#btnRequest').hide()
                                                    // $(idOrClass).find('#btnBook,#btnAddToCart').show()
                                                }
                                            }
                                        }else{
                                            // options.changeDate(null,null)
        
                                            GetMain_GetFormMain_GetTotalPrice(null,null,arr[0]['intMinimumPax'])
                                            // $(IdOrClass_Main + ' #btnSave').attr('disabled',true)
                                            $(IdOrClass_Main + ' #btnSave').hide()
                                        }
                                    }else{
                                        
                                        $(IdOrClass_Main + ' #pnPriceTotal').html('<b>Không tồn tại dịch vụ theo tiêu chí trên</b>')
                    
                                        $(IdOrClass_Main + ' #btnSave').hide()
                                    }


                                    // return JSON.parse(data)[0]   // Dữ liệu trả về từ api trên
                                }
                            }
                        }
                    })

                    

                }

                            
                function GetMain_GetFormMain_SetTourFix(){
                

                    var ObjForm =pngPn.getForm({
                        action: 2,
                        objInput: objInput,
                        idOrClass: _idOrClassPn
                    })

                    ObjForm = $.pngExtendObj(Obj_Detail,ObjForm)

                    // var idOrClassPn = idOrClass+' #pnPriceTotal'
                    var xmlNoOfChild = ''
                    // ObjSearchDtl.arrChildren.forEach(function(value){
                    //     xmlNoOfChild+='<child>'+value+'</child>'
                    // })

                    png.postListApiGetValue({           // Post list các Api phía trên và lấy về dữ liệu
                        objList_Api: ObjList_Api            // Tên các Object api đã khai báo phía trên 
                        // ,objList_ComboValue: ObjList_ComboValue // Tên các Object api dropdownlist đã khai báo phía trên 
                        ,objListApi_RtnVal: {           // Giá trị nhận về từ API
                            'GetListPaxBookingTourForBkByPUB':{               // Tên api tương ứng với giá trị trả về
                                objParams_Cus:{
                                     strTourGUID: Obj_Detail.strTourGUID
                                    // ,strPriceLevelGUID: Obj_Detail.strPriceLevelGUID
                                    ,intNoOfAdult: Obj_Detail.intAdults
                                    ,strListNoOfChild: Str_ListChildAge
                                    ,intNoOfSGLSup: Obj_Detail.intSGL
                                    ,intNoOfTPLRec: Obj_Detail.intTPL
                                    ,strPaxBookingTourCode: Obj_Detail.strPaxBookingTourCode
                    
                    
                                    ,strCompanyOwnerGUID: Obj_Detail.strCompanyGUID
                                    ,IsHasPriceKid: Obj_Detail.IsHasPriceKid
                                    ,intEasiaCateID: ObjForm.intEasiaCateID
                                    ,intCateID: Obj_Detail.intCateID
                                    ,intJoinTypeID:ObjForm.intJoinTypeID
                                    ,intTransportOptionID: ObjForm.intTransportOptionID
                                }
                                ,OnSuccess: function(data){

                                    var arr = JSON.parse(data)[0]
                                    if(arr.length){
                                        if(!arr[0]['IsNotAvailable']){

                                            // options.changeDate(DtmDateStart,ArrAllList[0][0]['dblTotalPrice'])
        
                                            GetMain_GetFormMain_GetTotalPrice(arr[0]['dblTotalPrice'],arr[0]['dblTotalPriceCom'],null,arr[0]['dblOldTotalPrice'])
                                            // $('#pnPriceTotal').html('<b>Total Price:</b> '+ $.pngFormatPrice(arr[0]['dblTotalPrice']) )
                                            // if(ObjForm.intJoinTypeID == 1)
                                                $('#pnPriceTotal').append('<div style="color:#F7904D;font-weight:bold">Remain: '+ $.pngFormatNumber(arr[0]['intTotalPaxRemain'])+' Pax</div>' )
                    
                    
                                            // $('#pnPriceTotal').attr('strTourPriceItemLevelGUID',)
                                            Str_DepartureTourLevelGUID = arr[0].strDepartureTourGUID
                                            Str_TourPriceItemLevelGUID = arr[0].strTourPriceItemGUID
                                            Str_PaxBookingTourCode =  arr[0].strPaxBookingTourCode
                                            
                                            // $(idOrClass + ' #btnBook').attr('disabled',false)
                    
                                            if(arr[0]['intTotalPaxRemain'] >= Obj_Detail.intTotalPax ){
                                                ShowBtnSendEq(false)
                                            }else{
                                                ShowBtnSendEq(true)
                                            }
                                            
                                            function ShowBtnSendEq(IsShow){
                                                if(IsShow){
                                                    // $(idOrClass).find('#btnBook,#btnAddToCart').hide()
                                                    // $(idOrClass).find('#btnRequest').show()
                                                    $(IdOrClass_Main + ' #btnSave').hide()
                                                }else{
                                                    $(IdOrClass_Main + ' #btnSave').show()
                                                    // $(idOrClass).find('#btnRequest').hide()
                                                    // $(idOrClass).find('#btnBook,#btnAddToCart').show()
                                                }
                                            }
                                        }else{
                                            // options.changeDate(null,null)
        
                                            GetMain_GetFormMain_GetTotalPrice(null,null,arr[0]['intMinimumPax'])
                                            $(IdOrClass_Main + ' #btnSave').attr('disabled',true)
                                        }
                                    }else{
                                        
                                        $(IdOrClass_Main + ' #pnPriceTotal').html('<b>Không tồn tại dịch vụ theo tiêu chí trên</b>')
                    
                                        $(IdOrClass_Main + ' #btnSave').hide()
                                    }

                                    // return JSON.parse(data)[0]   // Dữ liệu trả về từ api trên
                                }
                            }
                        }
                    })


                }
                function GetMain_GetFormMain_Tarrif(){
                    

                    var ObjForm =pngPn.getForm({
                        action: 2,
                        objInput: objInput,
                        idOrClass: idOrClass + ' #pnForm'
                    })

                    
                    ObjForm = $.pngExtendObj(ObjForm,Obj_Filter)

                    var xmlNoOfChild = ''
                    ObjSearchDtl.arrChildren.forEach(function(value){
                        xmlNoOfChild+='<child>'+value+'</child>'
                    })

                    var ObjParams_Cus = {
                        strTourGUID: options.objTourDetail.strTourGUID
                        ,intNoOfAdult: ObjSearchDtl.intNoAdult
                        ,intNoOfSGLSup: ObjSearchDtl.objNoOfRoom.sgl
                        ,intNoOfTPLRec: ObjSearchDtl.objNoOfRoom.tpl
                        ,xmlNoOfChild : xmlNoOfChild
                        ,dtmFilterDateFrom:  ObjSearchDtl.dtmDateStart
                        ,IsHasPriceKid: options.objTourDetail.IsHasPriceKid
                        ,intCateID: options.objTourDetail.intCateID
                    }
                    ObjParams_Cus = $.pngExtendObj(ObjParams_Cus,ObjForm)


                    if(ObjSearchDtl.dtmDateStart){
                        DtmDateStart = ObjSearchDtl.dtmDateStart
                        pngPn.getOutputApi({
                            objApi:ObjList_Api.GetListPriceItemTourByPUB
                            ,objParams_Cus: ObjParams_Cus
                            ,customEvent:function(ArrAllList){
                                if(ArrAllList[0].length){

                                    if(!ArrAllList[0][0]['IsNotAvailable']){
                                    
                                        options.changeDate(DtmDateStart,ArrAllList[0][0]['dblTotalPrice'])

                                        GetMain_GetFormMain_GetTotalPrice(ArrAllList[0][0]['dblTotalPrice'],ArrAllList[0][0]['dblTotalPriceCom'],null,ArrAllList[0][0]['dblOldTotalPrice'])
                                        // $('#pnPriceTotal').html('<b>Total Price:</b> '+ $.pngFormatPrice(ArrAllList[0][0]['dblTotalPrice']) )
                                        // $('#pnPriceTotal').append('<b>Commission Price:</b> '+ $.pngFormatPrice(ArrAllList[0][0]['dblTotalPriceCom']) )


                                        // $('#pnPriceTotal').attr('strTourPriceItemLevelGUID',)
                                        strTourPriceItemLevelGUID = ArrAllList[0][0].strTourPriceItemLevelGUID
                                        
                                        $(idOrClass + ' #btnBook').attr('disabled',false)

                                    }else{

                                        options.changeDate(null,null)

                                        GetMain_GetFormMain_GetTotalPrice(null,null,ArrAllList[0][0]['intMinimumPax'])
                                        $(idOrClass + ' #btnBook').attr('disabled',true)

                                    }
                                }else{
                                    options.changeDate(null,null)

                                    GetMain_GetFormMain_GetTotalPrice(null)
                                    $(idOrClass + ' #btnBook').attr('disabled',true)
                                    
                                }
                                
                            }
                        }) 
                    }
                        
                    else{
                        $('#pnPriceTotal').html('<b>Please choose Date Start</b> ')
                        $(idOrClass + ' #btnBook').attr('disabled',true)
                    }



                }

                
                function GetMain_GetFormMain_GetTotalPrice(dblTotalPrice,dblTotalPriceCom,intMinimumPax,dblOldTotalPrice){
                    var Dbl_TotalPrice = dblTotalPrice
                    if(dblTotalPrice){
                        var strHtml = ''
                        strHtml+= '<div style="font-size:20px;font-weight:bold;color:#1076FC"><b><span langkey="pg_Main_Tour_PPbook_TblTotalPrice"></span>:</b> '+ $.pngFormatPrice(dblTotalPrice)+'</div>'

                        if(dblOldTotalPrice)
                            strHtml+= '<div style="text-decoration: line-through;">(<b>Giá cũ:</b> '+ $.pngFormatPrice(dblOldTotalPrice)+')</div>'

                        $('#pnPriceTotal').html(strHtml)
                        // options.objTourDetail.dblTotalPriceCom=null
                        if(Obj_Detail.intComTypeID==1){
                            // options.objTourDetail.dblTotalPriceCom = dblTotalPriceCom
                            // $('#pnPriceTotal').append('<div>(<span langkey="pg_Main_Tour_MdDtl_CommissionPrice"></span>: <span style="color:red">'+ $.pngFormatPrice(dblTotalPriceCom) +'</span>)</div>')
                        }
                    }else{
                        // if(intMinimumPax){
                        //     $('#pnPriceTotal').html('<b>Số lượng Pax tối thiểu: '+intMinimumPax+'</b>')
                        // }else{
                            $('#pnPriceTotal').html('<b>Không có giá Tour theo Điều kiện trên.</b>')
                        // }
                    }
                }

                // GetMain_GetAgeAndRoom(_idOrClassPn+' .pnElm-pnAgeAndRoom',function(){
                    
                //     if(!_IsMobile){
                //         $.ModuleLayouts_Searchbar_GetValue(ObjSearchDtl)
                //         GetMain_GetFormMain()
                //     }else{
                //         GetValueForm()
                //     }
                // })
                
                // $( _idOrClassPn+' select').change( function() {
                //     if(!_IsMobile){
                //         GetMain_GetFormMain()
                //     }else{
                //         GetValueForm()
                //     }
                // });

                // function GetValueForm(){
                //     Obj_Filter = pngPn.getForm({
                //         action: 2,
                //         objInput: objInput,
                //         idOrClass: _idOrClassPn,
                //     })
                // }

                function GetMain_GetAgeAndRoom(idOrClassPn, _OnRtn){
                    var strHtml = ''
                    strHtml += '<div class=" dropdown">'
                    strHtml += '    <a class="form-control" data-toggle="dropdown" data-hover="dropdown" data-close-others="true">'
                    strHtml += '        <span class="ListNoPaxAndNoRoom2"></span> <i class="fa fa-angle-down" style="float: right;  margin-left: 5px;  line-height: 20px;"></i>'
                    strHtml += '    </a>'
                    strHtml += '    <ul class="dropdown-menu open-right tablet-pn-margin-0" id="ddlAgeType2" style="position: fixed;top: auto;right: 15px;width: 305px;width: min-content;">'
                    strHtml += '        <form role="form" style="display: inline-flex">'
                    strHtml += '            <div class="pnInputAgeType2" style="padding: 15px;"></div>'
                    strHtml += '            <style>'
                    strHtml += '                .pnInputAgeType2 #pnChildren{'
                    strHtml += '                    max-height: 30vh;overflow-x: hidden;'
                    strHtml += '                }'
                    strHtml += '            </style>'
                    strHtml += '            '
                    strHtml += '        </form>'
                    strHtml += '        <div style="padding: 15px;padding-top:0"><button id="btnSaveNoOfPax" class="btn btn-texticon bg-primary txt-white"><i class="fa fa-floppy-o"></i><span langkey="sys_Btn_Save"></span></button></div>'
                    strHtml += '    </ul>'
                    strHtml += '</div>'
                    $(idOrClassPn).html(strHtml)
            
                    var IntNoAdult,ArrChildren,ObjNoOfRoom
            
                    var ObjSearchDtl = {}
                    
                        ObjSearchDtl.intNoAdult = Obj_Detail.intAdults
                        if(Str_ListChildAge)
                            ObjSearchDtl.arrChildren = Str_ListChildAge.split(',')
                        else
                            ObjSearchDtl.arrChildren = []
                        // ObjNoOfRoom = ObjSearchDtl.objNoOfRoom
                        ObjSearchDtl.objNoOfRoom = null
                    
                    var strHtml_AgeType = ''
                    pngElm.getAgeType({
                        idOrClass: idOrClassPn+' .pnInputAgeType2'
                        ,intNoAdult: JSON.parse(JSON.stringify(ObjSearchDtl)).intNoAdult
                        ,arrChildren:JSON.parse(JSON.stringify(ObjSearchDtl)).arrChildren
                        ,objNoOfRoom: JSON.parse(JSON.stringify(ObjSearchDtl)).objNoOfRoom
                        ,intNoRoom: null
                        ,OnSuccess:function(intNoAdults,arrChildren,objNoOfRoom){
                            var intNoRooms = 0
                            Object.keys(objNoOfRoom).forEach(function(value){
                                intNoRooms+=objNoOfRoom[value]
                            })
                
                            strHtml_AgeType=''
                                strHtml_AgeType+= '<span>'+intNoAdults+' <span langkey="sys_Txt_Hd_shtAdt"></span></span>'
                                strHtml_AgeType+= ' - <span>'+arrChildren.length+' <span langkey="sys_Txt_Hd_shtKid"></span></span>'
                            
                            IntNoAdult = intNoAdults
                            ArrChildren = arrChildren
                            ObjNoOfRoom = objNoOfRoom
                
                            pngElm.ChangeLanguage()
                        }
                    })
            
            
                    $('.ListNoPaxAndNoRoom2', idOrClassPn).html(strHtml_AgeType)
                    pngElm.ChangeLanguage()
            
                    $('#btnSaveNoOfPax',idOrClassPn).click(function(){
                        Obj_Detail.intAdults = IntNoAdult
                        Str_ListChildAge = ArrChildren.join(',')
            
                        $('.ListNoPaxAndNoRoom2', idOrClassPn).html(strHtml_AgeType)
                        pngElm.ChangeLanguage()
            
                        _OnRtn.call(this)
            
                    })
                }


            }



        }

        objEvtPanel.pnBtn = function(_idOrClassPn){
            var IdOrClass_Pn = _idOrClassPn

            var strHtml = ''
            // if(Obj_PaymentAmountAndPeriod['IsPayment']){
            //     strHtml+= '<button id="btnPayment" class="btn bg-primary txt-white">Thanh toán</button>'
            // }else{
                strHtml+= '<button id="btnSave" class="btn bg-primary txt-white" style="">Save</button>'
                // strHtml+= '<button id="btnHold" class="btn bg-warning txt-white">Giữ chỗ</button>'
            // }
            $(IdOrClass_Pn).html(strHtml)

            $('#btnSave',IdOrClass_Pn).click(function(){

                png.postListApiGetValue({           // Post list các Api phía trên và lấy về dữ liệu
                    objList_Api: ObjList_Api            // Tên các Object api đã khai báo phía trên 
                    // ,objList_ComboValue: ObjList_ComboValue // Tên các Object api dropdownlist đã khai báo phía trên 
                    ,objListApi_RtnVal: {           // Giá trị nhận về từ API
                        'UpdOrderBookingItemForTour':{               // Tên api tương ứng với giá trị trả về
                            objParams_Cus:{
                                strTourPriceItemLevelGUID: Str_TourPriceItemLevelGUID,
                                strDepartureTourLevelGUID: Str_DepartureTourLevelGUID,
                                intAdult: Obj_Detail.intAdults,
                                strListChildAge: Str_ListChildAge,
                            }
                            ,OnSuccess: function(data){
                                
                                Obj_FN_Main.OnClosePp(false,true)
                                options.OnSuccess.call()
                                $.Confirm({ strContent: '<span langkey="sys_Cfm_UpdSuccess"></span>' });
                            }
                        }
                    }
                })
            })

        }

        // ===================================
        
        pngPn.getPanelHtml({            // Get ra panel dạng html
            objPanel: objPanel
            ,objEvtPanel: objEvtPanel
            ,idOrClass: IdOrClass_Main  // Id or class chính
            ,OnChangeIdPn: function(_Fn){
                Obj_FN_Main.pnMain = _Fn    // Hàm đổi trang
            }   
        })

    }

    
    function GetPopUp_PayMethod(_Opt){
        var Dft = {
            objDetail: {},
            ArrListAccount: [],
            IsBankAcc:null,
            //IsDuplicate:null,
            OnSuccess: function () {
    
            }
        }
        _Opt = $.extend(Dft, _Opt);

        var IdOrClass_Main = ''

        var Obj_Detail = _Opt.objDetail
        //---------Obj_XXX      // Khai báo các biến dùng chung cho cả hàm
        //---------Arr_XXX
        //---------Is_XXX
        //---------Int_XXX
        //---------Str_XXX

        // if(Object.keys(Obj_Detail).length){
        //     Is_Edit = true
        // }else{
        //     Is_Create = true
        // }
        // if(options.IsDuplicate){
        //     Is_Edit = false
        //     Is_Duplicate = true
        // }
        var Arr_BankAccountGUID = _Opt.ArrListAccount


        //------------------- Khái báo biển chính của giao diện
        var Obj_Filter_Dtl = {}
        var Obj_Filter = {}

        var Obj_FormInput = {}
        var Arr_ListTbl = []

        var Obj_FN_Main = {}
        //---------------
        GetPopUp()
        function GetPopUp(){
            var strTitle = 'Config Payment method'
            // if(Is_Create){
            //     strTitle = pngElm.getLangKey({langkey:'sys_Btn_Create'})
            // }
            
            // if(Is_Edit){
            //     strTitle = pngElm.getLangKey({langkey:'sys_Btn_Edit'})
            // }
            // if(Is_Duplicate){
            //     strTitle = pngElm.getLangKey({langkey:'sys_Btn_Duplicate'})
            // }
            pngPn.getPopUp({
                strTitle: strTitle
                , intTypeSize:1//------------1 small ---2 medium ---3 large
                , OnPanel: GetMainPanel
                , OnClosePopUp: function () {
                    //------Chọn sự kiện khi Đóng PopUP
                    // options.OnSuccess.call()
                    // _Opt.OnSuccess.call()
                }
            })
        }
    
        function GetMainPanel(_IdOrClassPp,_OnClosePp){
    
            IdOrClass_Main = _IdOrClassPp
            Obj_FN_Main.OnClosePp = _OnClosePp
    
            //Obj_FN_Main.OnClosePp(true)----------- chạy câu lệnh trong OnClosePopUp: function (){} khi tắt PopUp
            //Obj_FN_Main.OnClosePp(true,true)-----------Đóng Pop Up + chạy câu lệnh trong OnClosePopUp: function (){}
    
    
            var objPanel = {
                pnMain:{tag:'div',attr:'class=""'
                        ,childTags:[{div:'class="row"'}]
                    // ,pnListBtn:{tag:'div',attr:'class="col-md-12"'} 
                    // ,pnFormFilter:{tag:'div',attr:'class="col-md-12"'}
                    // ,pnTable:{tag:'div',attr:'class="col-md-12"'}
                    
                    ,pnForm:{tag:'div',attr:'class="col-md-12"'}
                    ,pnBtn:{tag:'div',attr:'class="col-md-12"'}
                }
            }
            var objEvtPanel = {}
            objEvtPanel.pnForm = function(_idOrClassPn){
                var IdOrClass_Pn = _idOrClassPn
                Obj_FormInput = {
                    ///-----------INSERT INPUT
                    intPaymentMethodID:{title:'Payment Method',isRequire:false,attr:"class='col-md-6'",IsRtn:true
                        ,input:{type:'select',classEx:'form-control',attr:''}
                        ,dropDown:{arrList: $.pngGetArrComboValue(Arr_PaymentMethod,'intID','strName') }
                    },

                    strCompanyBankAccountGUID:{title:'Bank Account',isRequire:false,attr:"class='col-md-6'",IsRtn:true
                        ,input:{type:'select',classEx:'form-control',attr:''}
                        ,dropDown:{arrList: $.pngGetArrComboValue(Arr_BankAccountGUID,'strCompanyBankAccountGUID','strNameDisplay') }
                    },
                    pnPayEx2:{title:'',attr:"class='col-md-12' style=''"
                        ,input:{IsNoInput:true}
                    },
                }
        
                pngPn.getForm({
                    action: 1,
                    objInput: Obj_FormInput,
                    idOrClass: IdOrClass_Pn,
                    objDetail: Obj_Detail,
                })

                if(_Opt.IsBankAcc){
                    $('.intPaymentMethodID',IdOrClass_Pn).parent().hide()
                }

                // $('.pnElm-pnAmount',IdOrClass_Pn).html(Dbl_VATAmount)

                // $('input',IdOrClass_Pn).change(function(){
                //     Dbl_VATAmount = Obj_Detail.dblTotalPrice/100*this.value
                //     $('.pnElm-pnAmount',IdOrClass_Pn).html(Dbl_VATAmount)
                // })
                $('.intPaymentMethodID',IdOrClass_Pn).change(function(){
                    if(this.value != 1){
                        $('.strCompanyBankAccountGUID',IdOrClass_Pn).parent().hide()
                    }else{
                        $('.strCompanyBankAccountGUID',IdOrClass_Pn).parent().show()
                    }

                    // $('input',IdOrClass_Pn).attr('disabled',(this.value == 1))
                }).change()

                $('.strCompanyBankAccountGUID',IdOrClass_Pn).change(function(){
                    GetPanelAccount(this.value)
                }).change()
                
                function GetPanelAccount(_strCompanyBankAccountGUID){
                        var obj = Arr_BankAccountGUID.filter(function(item){ return item.strCompanyBankAccountGUID == _strCompanyBankAccountGUID })[0]

                        strHtml =''
                        strHtml+='<div class="pn-margin-b-15"> '
                        strHtml+='<b>Account Name:</b> '+obj.strCompanyBankAccountName
                        strHtml+='<br><b>Account Code:</b> '+obj.strCompanyBankAccountCode
                        strHtml+='<br><b>Bank Name:</b> '+obj.strCompanyBankAccountInfo
                        strHtml+='<br><b>Bank Add:</b> '+obj.strBankAddress
                        strHtml+='<br><b>SwiftCode:</b> '+obj.strSwiftCode
                        strHtml+='</div> '

                        $('.pnElm-pnPayEx2 ', IdOrClass_Pn).html(strHtml)

                }
    
            }
            objEvtPanel.pnBtn = function(_idOrClassPn){
                var IdOrClass_Pn = _idOrClassPn
    
                var strHtml = ''
                    strHtml+='<button id="btnSave" class="btn btn-texticon bg-primary txt-white"><i class="fa fa-floppy-o"></i><span>'+pngElm.getLangKey({langkey:'sys_Btn_Save'})+'</span></button>'
                $(IdOrClass_Pn).html(strHtml)
    
                $(IdOrClass_Pn+ ' #btnSave').click(function(){
                    pngPn.getForm({
                        action: 2,
                        objInput: Obj_FormInput,
                        idOrClass: IdOrClass_Main + ' #pnForm',
                        OnChkSuccess: function(objRtn){
                            if (objRtn) {
    
                                // objRtn = $.pngExtendObj(Obj_Detail,objRtn)
                                
                                if(objRtn.intPaymentMethodID != 1)
                                    objRtn.strCompanyBankAccountGUID = null
                                
                                Obj_FN_Main.OnClosePp(false,true)
                                _Opt.OnSuccess.call(this,objRtn)
                            }
                            
                            
                        }
                    })
                })
            }
            // ===================================
            
            pngPn.getPanelHtml({            // Get ra panel dạng html
                objPanel: objPanel
                ,objEvtPanel: objEvtPanel
                ,idOrClass: IdOrClass_Main  // Id or class chính
                ,OnChangeIdPn: function(_Fn){
                    Obj_FN_Main.pnMain = _Fn    // Hàm đổi trang
                }   
            })
            
            
    
        }
    }

    
    function GetPopUp_ListCommission(_Opt){
        var Dft = {
            strCompanyGUID: null,
            arrListCom: null,
            OnSuccess: function () {
    
            }
        }
        _Opt = $.extend(Dft, _Opt);

        var IdOrClass_Main = ''

            
        //---------Obj_XXX      // Khai báo các biến dùng chung cho cả hàm
        //---------Arr_XXX
        //---------Is_XXX
        //---------Int_XXX
        //---------Str_XXX

        

        //------------------- Khái báo biển chính của giao diện
        var Obj_Filter_Dtl = {}
        var Obj_Filter = {}

        // var Obj_FormInput = {}
        var Arr_ListTbl = JSON.parse(JSON.stringify(_Opt.arrListCom))

        var Obj_FN_Main = {}
        //-------------------
        

        GetPopUp()

        function GetPopUp(){
            var strTitle = 'Danh sách hoa hồng'
            pngPn.getPopUp({
                strTitle: strTitle
                , intTypeSize:1//------------1 small ---2 medium ---3 large
                , OnPanel: GetMainPanel
                , OnClosePopUp: function () {
                    //------Chọn sự kiện khi Đóng PopUP
                }
            })
        }
    
        function GetMainPanel(_IdOrClassPp,_OnClosePp){
    
            IdOrClass_Main = _IdOrClassPp
            Obj_FN_Main.OnClosePp = _OnClosePp
    
            // _Obj_FN_Main.OnClosePp(true)----------- chạy câu lệnh trong OnClosePopUp: function (){} khi tắt PopUp
            // _Obj_FN_Main.OnClosePp(true,true)-----------Đóng Pop Up + chạy câu lệnh trong OnClosePopUp: function (){}
    
    
            var objPanel = {
                pnMain:{tag:'div',attr:'class=""'
                        ,childTags:[{div:'class="row"'}]
                    ,pnTable:{tag:'div',attr:'class="col-md-12"'}
                    ,pnBtn:{tag:'div',attr: 'class="col-md-12"'}
                }
            }
            var objEvtPanel = {}
            objEvtPanel.pnTable = function(_idOrClassPn){
                var IdOrClass_Pn = _idOrClassPn
                
                // setTimeout(function(){
                //     $(IdOrClass_MainItem+ " .viewSave").attr('disabled',true)
                // },100)
                
                pngPn.getTable2({
                    objApi:null
                    ,objParams_Cus:null
                    ,objCols:  {
                        No:{name:'No.',IsViewInputWhenCheck:true
                        }
                        // , strAgentName: { name: 'Tên Đại lý' }
                        , strOrderAgentHostCode_View: { name: 'Mã Booking/Group Name' }
                        , strServiceName: { name: 'Tên dịch vụ'}
                        // , strGroupName: { name: 'Group Name' }
                        , dtmDateFromTo_View: { name: 'Ngày bắt đầu - Ngày kết thúc' }
                        // , dtmDateTo_View: { name: 'Ngày kết thúc' }
                        , intTotalPax: { name: 'Tổng số Pax'}
                        , dblPayableBalance_View: { name: 'Số tiền còn lại', strAttrTD:' style="text-align:right"'}
                    }
                    ,editRltArr: function(arr){
                    	return Arr_ListTbl
                    }
                    ,editRlt: function(value,key){

                        value['No']=(key+1)
                        value['strOrderAgentHostCode_View'] = '<a href="/?page=bookingdetail&BKID='+value['strBookingGUID']+'" target="_Booking">'+value['strOrderAgentHostCode']+'/'+value['strGroupName']+'</a>'
    
                        value['dtmDateFromTo_View'] = $.pngFormatDateTime(value['dtmDateFrom'],'DD MMM YYYY') + ' - ' +  $.pngFormatDateTime(value['dtmDateTo'],'DD MMM YYYY')
                        // value['dtmDateTo_View'] = $.pngFormatDateTime(value['dtmDateTo'])
                        value['dblPriceTotal_View'] = $.pngFormatPrice(value['dblPriceTotal'])
                        value['dblPayableBalance_View'] = $.pngFormatPrice(value['dblPayableBalance'])
                        value['dblPaid_View'] = $.pngFormatPrice(value['dblPaid'])
                    }
                    ,customEvent:function(idOrClassPn){
                        
                    }
                    ,changeCkbMaster: function (IsChecked, intRowID, arrList) {
                        // if (IsChecked)
                        //     $(IdOrClass_Pn + ' tr[row=' + intRowID + '] td').css('background', '#e7eefb')
                        // else
                        //     $(IdOrClass_Pn + ' tr[row=' + intRowID + '] td').removeAttr('style')
            
            
                        // if($(IdOrClass_Pn+' input[chkboxMaster="true"]:checked').length == 0){
                        //     $(IdOrClass_MainItem+ " .viewSave>span.intITs").text('')
                        //     $(IdOrClass_MainItem+ " .viewSave").attr('disabled',true)
                        // }else{
                        //     $(IdOrClass_MainItem+ " .viewSave>span.intITs").text(' (' + $(IdOrClass_Pn+' input[chkboxMaster="true"]:checked').length + ')')
                        //     $(IdOrClass_MainItem+ " .viewSave").attr('disabled',false)
                        // }
        
                        Arr_ListTbl = arrList;
                    }
                    ,IsViewCheckBoxMain:true
                    ,idOrClass:IdOrClass_Pn 
                })


    
            }
            objEvtPanel.pnBtn = function(_idOrClassPn){
                var IdOrClass_Pn = _idOrClassPn
    
                var strHtml = ''
                    strHtml+='<button id="btnSave" class="viewSave btn btn-texticon bg-primary txt-white"><i class="fa fa-floppy-o"></i><span>Save</span><span class="intITs"></span></button>'
                $(IdOrClass_Pn).html(strHtml)
    
                $('#btnSave').click(function(){
                    _Opt.OnSuccess.call(this,Arr_ListTbl)
                    Obj_FN_Main.OnClosePp(false,true)
                })
            }
            // ===================================
            
            pngPn.getPanelHtml({            // Get ra panel dạng html
                objPanel: objPanel
                ,objEvtPanel: objEvtPanel
                ,idOrClass: IdOrClass_Main  // Id or class chính
                ,OnChangeIdPn: function(_Fn){
                    Obj_FN_Main.pnMain = _Fn    // Hàm đổi trang
                }   
            })
            
            
    
        }
    }


}


$.ModulePage_OrderStep1_PopUpEditService_Hotel = function (options) {
    var defaults = {
        strUserGUID: ''
        ,strCompanyPartnerGUID: ''
        ,strCompanyOwnerGUID: ''
        ,objDetail: {}
        ,IsEditRoomType: null
        ,IsEditPax: null
        ,IsEditPaxChild: null
        ,OnSuccess: function () {
        }
    }
    options = $.extend(defaults, options);


    var IdOrClass_Main = ''

    
    //---------Obj_XXX
    //---------Arr_XXX
    //---------Is_XXX
    //---------Int_XXX
    //---------Str_XXX
    
    var Obj_Detail = options.objDetail


    var ObjList_Api = {
        
        GetListSupplierMappingPriceForHotelByAgent:{
            strApiLink:'api/supplier/GetListSupplierMappingPriceForHotelByAgent'
            ,objParams:{
                strUserGUID : options.strUserGUID
                ,strSupplierMappingPriceGUID : null
                ,strSupplierGUID :  Obj_Detail.strSupplierGUID
                ,strPriceListGUID: Obj_Detail.strPriceListGUID
                ,strPriceLevelGUID : Obj_Detail.strPriceLevelGUID
                ,strCompanyOwnerGUID : Obj_Detail.strCompanyGUID
                ,dtmFilterCheckIn : $.pngFormatDateTime(Obj_Detail.dtmDateFrom,'l')
                ,dtmFilterCheckOut : $.pngFormatDateTime(Obj_Detail.dtmDateTo,'l')
                ,intCurPage : null
                ,intPageSize : null
                ,strOrder : null
                ,tblsReturn : '[0][1]'
            }
        },

        
        GetListItemTypeByAgent:{
            strApiLink:'api/supplier/GetListItemTypeByAgent'
            ,objParams:{
                strUserGUID : options.strUserGUID
                ,strItemTypeGUID: Obj_Detail.strItemTypeGUID
                ,strSupplierGUID: Obj_Detail.strSupplierGUID
                ,strCompanyOwnerGUID: null
            
                ,intCurPage: null
                ,intPageSize: null
                ,strOrder: null
                ,tblsReturn:'[0][1]'
            }
        },
        

        GetListLinkSupplierChildAge:{
            strApiLink:'api/supplier/GetListLinkSupplierChildAge'
            ,objParams:{
                strUserGUID : options.strUserGUID,
                strLinkSupplierChildAgeGUID : null,
                strItemTypeGUID : Obj_Detail.strSupplierGUID,
                intCurPage : null,
                intPageSize : null,
                strOrder : null,
                tblsReturn : '[0]',
            }
        },

        UpdOrderBookingItemForHotel:{
            strApiLink:'api/booking/UpdOrderBookingItemForHotel'
            ,objParams:{
                strUserGUID : options.strUserGUID
                ,strPassengerOrderItemGUID: Obj_Detail.strPassengerOrderItemGUID
                ,intSglDblID: null
                ,intQuantity: null
            }
        },

        GetListFoc:{
            strApiLink:'api/supplier/GetListFoc'
            ,objParams:{
                strUserGUID : options.strUserGUID
                ,strSupplierGUID : Obj_Detail.strSupplierGUID
                ,strFocGUID : null
                ,strPriceListGUID: Obj_Detail.strPriceListGUID
                ,intFOCTypeID : null
                ,dtmFilterDateFrom: $.pngFormatDateTime(Obj_Detail.dtmDateFrom,'l')
                ,dtmFilterDateTo: $.pngFormatDateTime(Obj_Detail.dtmDateTo,'l')

                ,intCurPage : null
                ,intPageSize : null
                ,strOrder : null
                ,tblsReturn : '[0]'
            }
        },

    }

    var ObjList_ComboValue = {
    }

    //---------
    var Obj_FormInput = {}
    var Obj_FN_Main = {}
    //---------
    var Arr_ListChild = []

    var IsBookNotMinstay = null
    var Arr_ListFOCUse = []

    var Arr_ListItemTypeDetail = []
    var ArrPriceRoom = []
    var Arr_ListDate = []
    var Arr_ListFoc = []

    var Is_GIT = false
    // Arr_ListService.forEach(function(value){
    //     strListOrderBookingItemGUID+=value.strPassengerOrderItemGUID+','
    // })
    var Arr_ListItemType = []

    var Int_Quantity = Obj_Detail.intQuantity

    png.postListApiGetValue({
        objList_Api: ObjList_Api
        // ,objList_ComboValue: ObjList_ComboValue
        ,objListApi_RtnVal: {           // Giá trị nhận về từ API
            'GetListItemTypeByAgent':{               // Tên api tương ứng với giá trị trả về
                objParams_Cus:{
                }
                ,OnSuccess: function(data){
                    // return JSON.parse(data)[0]   // Dữ liệu trả về từ api trên
                    Arr_ListItemTypeDetail =  JSON.parse(data)[1]

                    var obj = Arr_ListItemTypeDetail.filter(function(item){ return item.intSglDblID == Obj_Detail.intSglDblID })[0]

                    
                    if(options.IsEditPax || options.IsEditRoomType)
                        Arr_ListItemType.push({strItemTypeGUID: Obj_Detail.strItemTypeGUID,strSglDblCode: obj.strSglDblCode})
                    if(options.IsEditPaxChild)
                        Arr_ListItemType.push({strItemTypeGUID: Obj_Detail.strItemTypeGUID,strSupplierChildAgeGUID: Obj_Detail.strSupplierChildAgeGUID})
                    
                }
            },
            'GetListSupplierMappingPriceForHotelByAgent':{               // Tên api tương ứng với giá trị trả về
                objParams_Cus:{
                }
                ,OnSuccess: function(data){
                    // return JSON.parse(data)[0]   // Dữ liệu trả về từ api trên
                    ArrPriceRoom = JSON.parse(data)[0]
                    Arr_ListDate = JSON.parse(data)[1]

                }
            },
            
            GetListFoc:{
                objParams_Cus:{
                }
                ,OnSuccess: function(data){

                    Arr_ListFoc = JSON.parse(data)[0]

                }
            },
        }
        // ,objListComboValue_RtnVal: {
            
        // }
        ,OnSuccessList:function(data){
            if(options.IsEditPax || options.IsEditRoomType)
                GetPopUp()
            else
                png.postListApiGetValue({
                    objList_Api: ObjList_Api
                    // ,objList_ComboValue: ObjList_ComboValue
                    ,objListApi_RtnVal: { 
                        'GetListLinkSupplierChildAge':{
                            objParams_Cus:{
                                strItemTypeGUID: Obj_Detail.strItemTypeGUID
                            }
                            , OnSuccess: function(data){ 
                                Arr_ListChild = JSON.parse(data)[0]
                                GetPopUp()

                            }
                        },
                    }
                })
        }
    })

    // GetPopUp()
    function GetPopUp(){
        pngPn.getPopUp({
            strTitle: 'Update service'
            , intTypeSize:1//------------1 small ---2 medium ---3 large
            , OnPanel: GetMainPanel
            , OnClosePopUp: function () {
                //------Chọn sự kiện khi Đóng PopUP
            }
        })
    }

    function GetMainPanel(_IdOrClassPp,_OnClosePp){

        IdOrClass_Main = _IdOrClassPp
        Obj_FN_Main.OnClosePp = _OnClosePp

        // Obj_FN_Main.OnClosePp(true)----------- chạy câu lệnh trong OnClosePopUp: function (){} khi tắt PopUp
        // Obj_FN_Main.OnClosePp(true,true)-----------Đóng Pop Up + chạy câu lệnh trong OnClosePopUp: function (){}

        var objPanel= {
            pnMain:{tag:'div',attr:'class=""',childTags:[{div:'class="row"'}]
                ,pnContent:{tag:'div',attr:'class="col-md-12"'}
                ,pnBtn:{tag:'div',attr:'class="col-md-12" '}
            }
        }

        var objEvtPanel = {}
        objEvtPanel.pnContent = function(_idOrClassPn){
            var IdOrClass_Pn = _idOrClassPn

            var strHtml = ''
            strHtml+= '         <div class="pn-margin-b-15"><b>Service:</b> '+Obj_Detail.strServiceName+'</div>'
            if(options.IsEditPax ){
                if(Arr_ListFoc.length){
                    strHtml += '<div class="pn-padding-b-15" style="color:red">(Bạn hãy chọn '+Arr_ListFoc[0].intFOCPax+' phòng trở lên để được giá GIT)</div>' 
                }
            }
            strHtml+= '         <div id="pnForm"></div>'
            strHtml+= '         <div id="pnPriceTotal" style="padding: 0 0 10px;margin-bottom: 15px;"></div>'
            strHtml+= '         <div class="pnListFOC" style=""></div>'

            $(IdOrClass_Pn).html(strHtml)

            // console.log(Arr_ListItemTypeDetail)
            if(options.IsEditPax || options.IsEditPaxChild){
                Obj_FormInput = {
                    intSglDblID:{title:'Quantity',attr:"class='col-md-6'",isRequire:true,IsRtn:true
                        ,input:{IsNoInput:true}
                        ,OnLoadHtml:function (_idOrClass_Pn) {
                            var strHtml = `
                                
                                <div class="pnQuantity" style="display: inline-flex;padding-bottom: 10px;">
                                    <span style="width: 160px;">
                                        <a class="exp qty" style="padding: 0 10px;display: inline-block;background: #d8d8d8; cursor: pointer;">-</a>
                                        <div style="width: 40px;text-align: center;display: inline-block;">
                                            <span class="no-qty">0</span>
                                        </div>
                                        <a class="add qty" style="padding: 0 10px;display: inline-block;background: #d8d8d8; cursor: pointer;">+</a> 
                                    </span>
                                </div>
                            `
                            $(_idOrClass_Pn).html(strHtml)

                            
                            $('.exp.qty',_idOrClass_Pn).click(function(){
                                var val = Int_Quantity

                                if(val>0){
                                    val-=1
                                }
                                Int_Quantity = val
    
                                GetPrice()
                                GetTotal()
                            })

                            
                            $('.add.qty',_idOrClass_Pn).click(function(){
                                var val = Int_Quantity

                                // if(val>0){
                                    val+=1
                                // }
                                Int_Quantity = val
    
                                GetPrice()
                                GetTotal()
                            })
                            

                        }
                    },
                }
            }else{
                Obj_FormInput = {
                    intSglDblID:{title:'Room type',attr:"class='col-md-6'",isRequire:true,IsRtn:true
                        ,input:{type:'select',classEx:'form-control',attr:''}
                        ,dropDown:{IsViewSlcOpt:false, arrList: $.pngGetArrComboValue(Arr_ListItemTypeDetail,'intSglDblID','strSglDblName'),OnLoadData:null }//-------------------$.pngGetArrComboValue(ArrList,'intID','strName')
                    },
                }
            }
    
            pngPn.getForm({
                action: 1,
                objInput: Obj_FormInput,
                idOrClass: IdOrClass_Pn+' #pnForm',
                objDetail: Obj_Detail,
            })

            $('.intSglDblID',IdOrClass_Pn+' #pnForm').change(function(){
                Obj_Detail.intSglDblID = this.value

                var obj = Arr_ListItemTypeDetail.filter(function(item){ return item.intSglDblID == Obj_Detail.intSglDblID })[0]

                Arr_ListItemType = []
                if(options.IsEditRoomType)
                    Arr_ListItemType.push({strItemTypeGUID: Obj_Detail.strItemTypeGUID,strSglDblCode: obj.strSglDblCode})
                
                GetPrice()
                GetTotal()
            })

            GetPrice()
            GetTotal()
            function GetTotal(){

                console.log(Arr_ListItemType)
                $('.no-qty', IdOrClass_Pn+' #pnForm').html(Int_Quantity)

                var strHtml = ''
                strHtml+= '<div style="font-size:20px;font-weight:bold;color:#1076FC"><b><span langkey="">'+pngElm.getLangKey({langkey:'pg_Main_Tour_PPbook_TblTotalPrice'})+'</span>:</b> '+ $.pngFormatPrice(Arr_ListItemType[0].dblUnitPrice*Int_Quantity)+' '+(Is_GIT? '<div class="pnGITPrice" style="display: inline-block;color: #232323;">(<i class="fa fa-usd"></i> GIT)</div>' : '')+'</div>'
                strHtml+= '<div>(<span langkey="">'+pngElm.getLangKey({langkey:'pg_Main_Tour_MdDtl_CommissionPrice'})+'</span>: <span style="color:red">'+ $.pngFormatPrice(Arr_ListItemType[0].dblUnitComPrice*Int_Quantity) +'</span>)</div>'
                // if(dblOldTotalPrice)
                //     strHtml+= '<div style="text-decoration: line-through;">(<b>Giá cũ:</b> '+ $.pngFormatPrice(dblOldTotalPrice)+')</div>'
    
                $('#pnPriceTotal').html(strHtml)
            }


        }

        objEvtPanel.pnBtn = function(_idOrClassPn){
            var IdOrClass_Pn = _idOrClassPn

            var strHtml = ''
            // if(Obj_PaymentAmountAndPeriod['IsPayment']){
            //     strHtml+= '<button id="btnPayment" class="btn bg-primary txt-white">Thanh toán</button>'
            // }else{
                strHtml+= '<button id="btnSave" class="btn bg-primary txt-white" style="">Save</button>'
                // strHtml+= '<button id="btnHold" class="btn bg-warning txt-white">Giữ chỗ</button>'
            // }
            $(IdOrClass_Pn).html(strHtml)

            $('#btnSave',IdOrClass_Pn).click(function(){

                png.postListApiGetValue({           // Post list các Api phía trên và lấy về dữ liệu
                    objList_Api: ObjList_Api            // Tên các Object api đã khai báo phía trên 
                    // ,objList_ComboValue: ObjList_ComboValue // Tên các Object api dropdownlist đã khai báo phía trên 
                    ,objListApi_RtnVal: {           // Giá trị nhận về từ API
                        'UpdOrderBookingItemForHotel':{               // Tên api tương ứng với giá trị trả về
                            objParams_Cus: $.pngExtendObj(Obj_Detail,{
                                intQuantity: Int_Quantity
                            })
                            ,OnSuccess: function(data){
                                
                                Obj_FN_Main.OnClosePp(false,true)
                                options.OnSuccess.call()
                                $.Confirm({ strContent: '<span langkey="sys_Cfm_UpdSuccess"></span>' });
                            }
                        }
                    }
                })
            })

        }

        // ===================================
        
        pngPn.getPanelHtml({            // Get ra panel dạng html
            objPanel: objPanel
            ,objEvtPanel: objEvtPanel
            ,idOrClass: IdOrClass_Main  // Id or class chính
            ,OnChangeIdPn: function(_Fn){
                Obj_FN_Main.pnMain = _Fn    // Hàm đổi trang
            }   
        })

    }

    function GetPrice(){

        
        Arr_ListItemType.forEach(function(value,key){

            var arr = []
            
            value['arrListPrice'] = []

            if(options.IsEditPax || options.IsEditRoomType)
                arr = ArrPriceRoom.filter(function(item){ return (item.strItemTypeGUID || '').toUpperCase() == value.strItemTypeGUID.toUpperCase() })
            
            if(options.IsEditPaxChild)
                arr = ArrPriceRoom.filter(function(item){ return (item.strSupplierChildAgeGUID || '').toUpperCase() == value.strSupplierChildAgeGUID.toUpperCase() })
            
            // console.log( value)
            // console.log( ArrPriceRoom)
            // var arrListDate = ArrPriceRoom.map(item => item.dtmDate)
            //                 .filter((value, index, self) => self.indexOf(value) === index)
            
            var obj = null
            if( arr.length ){

                obj = arr[0]

                var intQuantity = 1
                var dtmDateFrom
                var dtmDateTo
                var dblUnitPrice = 0

                var objPriceDetail = {}
                Is_GIT = false

                var IsNA = false

                Arr_ListDate.forEach(function(_val){

                    var arr = []

                    if(options.IsEditPax || options.IsEditRoomType)
                        arr = ArrPriceRoom.filter(function(item){ return (item.strItemTypeGUID || '').toUpperCase() == value.strItemTypeGUID.toUpperCase() && item.strPriceSeasonGUID.toUpperCase() == (_val.strPriceSeasonGUID || '').toUpperCase() })
                    if(options.IsEditPaxChild)
                        arr = ArrPriceRoom.filter(function(item){ return (item.strSupplierChildAgeGUID || '').toUpperCase() == value.strSupplierChildAgeGUID.toUpperCase() && item.strPriceSeasonGUID.toUpperCase() == (_val.strPriceSeasonGUID || '').toUpperCase()  })
                
                    if( arr.length ){

                        val = arr[0]

                        var dblUnitPriceItem = 0
                        var dblUnitComPriceItem = 0

                        if(options.IsEditPax || options.IsEditRoomType){
                            
                            var IsGITItem = false
                            
                            if(Arr_ListFoc.filter(function(item){  return Int_Quantity >= item.intFOCPax }).length   ){
                                IsGITItem = true
                                Is_GIT = true
                            }
                            
                            if(value.strSglDblCode == 'Dbl' || value.strSglDblCode == 'Twn' || value.strSglDblCode.indexOf('St')!=-1){
                        
                                if( IsGITItem){
                                    dblUnitPriceItem = val.dblGITPrice
                                    dblUnitComPriceItem = val.dblComGITPrice
                                }else{
                                    dblUnitPriceItem = val.dblPrice
                                    dblUnitComPriceItem = val.dblComPrice
                                }



                            }
                            if(value.strSglDblCode == 'Sgl'){
                                if(IsGITItem){
                                    dblUnitPriceItem = val.dblGITPriceSGL
                                    dblUnitComPriceItem = val.dblComGITPriceSGL
                                }else{
                                    dblUnitPriceItem = val.dblPriceSGL
                                    dblUnitComPriceItem = val.dblComPriceSGL
                                }
                            }
                            if(value.strSglDblCode == 'Tpl'){
                                if(IsGITItem){
                                    dblUnitPriceItem = val.dblGITPriceTPL
                                    dblUnitComPriceItem = val.dblComGITPriceTPL
                                }else{
                                    dblUnitPriceItem = val.dblPriceTPL
                                    dblUnitComPriceItem = val.dblComPriceTPL
                                }
                            }
                        }

                        if(options.IsEditPaxChild){
                            dblUnitPriceItem = val.dblPrice
                            dblUnitComPriceItem = val.dblComPrice
                        }

                        if(dblUnitPrice!=dblUnitPriceItem){
                            intQuantity = 1
                            dblUnitPrice=dblUnitPriceItem
                            dtmDateFrom = $.pngFormatDateTime(_val.dtmDate,'l')

                            if(Object.keys(objPriceDetail).length)
                                value['arrListPrice'].push(objPriceDetail)
                        }else{
                            intQuantity++
                        }

                        dtmDateTo = moment($.pngFormatDateTime(_val.dtmDate,'l')).add('days',1).format('l')

                        objPriceDetail = {
                            intQuantity: intQuantity,
                            dblUnitPrice: dblUnitPrice,
                            dblUnitComPrice: dblUnitComPriceItem,
                            dtmDateFrom: dtmDateFrom,
                            dtmDateTo: dtmDateTo,
                            strPriceSeasonGUID: _val.strPriceSeasonGUID
                        }
                    }else{
                        IsNA=true
                    }

                })

                value['arrListPrice'].push(objPriceDetail)

                if(!IsNA){
                    value['IsInstantBooking'] = true
                    value['dblUnitPrice'] = 0
                    value['dblUnitComPrice'] = 0
                    value['arrListPrice'].forEach(function(val){
                        value['dblUnitPrice']+= val.intQuantity*val.dblUnitPrice
                        value['dblUnitComPrice']+= val.intQuantity*val.dblUnitComPrice
                    })
                    value['intAllotmentRemain'] = obj.intAllotmentRemain

                    // $('[row='+key+'] .pnElm-PnAvailable','#pnListRoom .pnListPrice').html('(<b>Available:</b> '+obj.intAllotmentRemain+')')

                    // $('[row='+key+'] .pnQuantity','#pnListRoom .pnListPrice').show().change()
                    // $('[row='+key+'] .txtNA','#pnListRoom .pnListPrice').hide()
                    
                    // $('[row='+key+'] .pn-dblUnitPrice','#pnListRoom .pnListPrice').html('<a action="ViewUnitPrice" intRowID="'+key+'" style="cursor: inherit;position:relative">'+$.pngFormatPrice((value['dblUnitPrice']))+'</a>')



                    if ($(window).width() >= 1024){

                        $( '[row='+key+'] a[action=ViewUnitPrice]','#pnListRoom .pnListPrice' ).hover(function() {

                            var obj = Arr_ListItemType[$(this).attr('intRowID')]
                    
                            var strHtml = ''
                            strHtml+='<div id="pnSeeMore" class="bg-white pn-padding-15" style="position:absolute;z-index: 2;line-height: 25px;box-shadow: 0px 0px 18px -7px;text-align:left;right: 0;width:400px">'
                            
                            obj.arrListPrice.forEach(function(value){
                                strHtml+= ''
                                strHtml+='<div><b>'+$.pngFormatDateTime(value.dtmDateFrom)+' - '+$.pngFormatDateTime(value.dtmDateTo)+'</b></div>'
                                strHtml+='<div> '+value.intQuantity+' x '+$.pngFormatPrice(value.dblUnitPrice)+'</div>'

                            })

                            strHtml+='</div>'

                            $( this ).append( strHtml );
                        }, function() {
                        $( this ).find( "#pnSeeMore" ).remove();
                        }
                    
                        );
                    }else{
                        $('[row='+key+'] a[action=ViewUnitPrice]','#pnListRoom .pnListPrice' ).click(function(){
                            
                            var obj = Arr_ListItemType[$(this).attr('intRowID')]
                            GetPanelFullScreen(function(_idOrClassPn){
            
                                
                                var strHtml = ''
                                strHtml+='<div id="pnSeeMore" class="bg-white pn-padding-15" style="">'
                                
                                obj.arrListPrice.forEach(function(value){
                                    strHtml+= ''
                                    strHtml+='<div><b>'+$.pngFormatDateTime(value.dtmDateFrom)+' - '+$.pngFormatDateTime(value.dtmDateTo)+'</b></div>'
                                    strHtml+='<div> '+value.intQuantity+' x '+$.pngFormatPrice(value.dblUnitPrice)+'</div>'

                                })

                                strHtml+='</div>'

                                $(_idOrClassPn).html(strHtml)
        
                            })
                        })


                    }


                }else{
                    // value['arrListPrice'].push({
                    //     intQuantity: null,
                    //     dblUnitPrice: null,
                    //     dblUnitComPrice: null,
                    //     dtmDateFrom: null,
                    //     dtmDateTo: null,
                    //     strPriceSeasonGUID: null
                    // })
                }


            }else{
                value['arrListPrice'].push({
                    intQuantity: null,
                    dblUnitPrice: null,
                    dblUnitComPrice: null,
                    dtmDateFrom: null,
                    dtmDateTo: null,
                    strPriceSeasonGUID: null
                })
            }


        })


    }

}


$.ModulePage_OrderStep1_PopUpEditService_Surcharge = function (options) {
    var defaults = {
        strUserGUID: ''
        ,strCompanyPartnerGUID: ''
        ,strCompanyOwnerGUID: ''
        ,objDetail: {}
        ,OnSuccess: function () {
        }
    }
    options = $.extend(defaults, options);


    var IdOrClass_Main = ''

    
    //---------Obj_XXX
    //---------Arr_XXX
    //---------Is_XXX
    //---------Int_XXX
    //---------Str_XXX
    
    var Obj_Detail = options.objDetail


    var ObjList_Api = {
        
        GetListSupplierMappingPriceForHotelByAgent:{
            strApiLink:'api/supplier/GetListSupplierMappingPriceForHotelByAgent'
            ,objParams:{
                strUserGUID : options.strUserGUID
                ,strSupplierMappingPriceGUID : null
                ,strSupplierGUID :  Obj_Detail.strSupplierGUID
                ,strPriceListGUID: Obj_Detail.strPriceListGUID
                ,strPriceLevelGUID : Obj_Detail.strPriceLevelGUID
                ,strCompanyOwnerGUID : Obj_Detail.strCompanyGUID
                ,dtmFilterCheckIn : $.pngFormatDateTime(Obj_Detail.dtmDateFrom,'l')
                ,dtmFilterCheckOut : $.pngFormatDateTime(Obj_Detail.dtmDateTo,'l')
                ,intCurPage : null
                ,intPageSize : null
                ,strOrder : null
                ,tblsReturn : '[0][1]'
            }
        },

        
        GetListSurchargeDateForAgent:{
            strApiLink:'api/supplier/GetListSurchargeDateForAgent'
            ,objParams:{
                strUserGUID : options.strUserGUID
                ,strSurchargeDateGUID: Obj_Detail.strSurchargeDateGUID
                ,strSupplierGUID :  Obj_Detail.strSupplierGUID
                ,strCompanyOwnerGUID : null
                ,dtmFilterDateFrom : null
                ,dtmFilterDateTo : null
                ,intCurPage : null
                ,intPageSize : null
                ,strOrder : null
                ,tblsReturn : '[0]'
            }
        },

        UpdOrderBookingItemForHotel:{
            strApiLink:'api/booking/UpdOrderBookingItemForHotel'
            ,objParams:{
                strUserGUID : options.strUserGUID
                ,strPassengerOrderItemGUID: Obj_Detail.strPassengerOrderItemGUID
                ,intSglDblID: null
                ,intQuantity: null
            }
        },
    }

    var ObjList_ComboValue = {
    }

    //---------
    var Obj_FormInput = {}
    var Obj_FN_Main = {}
    //---------


    // Arr_ListService.forEach(function(value){
    //     strListOrderBookingItemGUID+=value.strPassengerOrderItemGUID+','
    // })
    var Arr_Surcharge = []
    var Arr_SurchargePrice = []

    var Int_Quantity = Obj_Detail.intQuantity

    png.postListApiGetValue({
        objList_Api: ObjList_Api
        // ,objList_ComboValue: ObjList_ComboValue
        ,objListApi_RtnVal: {           // Giá trị nhận về từ API
            'GetListSurchargeDateForAgent':{
                objParams_Cus:{
                    tblsReturn:'[0][1]'
                }
                ,OnSuccess: function(data){
                    Arr_Surcharge = JSON.parse(data)[0]
                    Arr_SurchargePrice = JSON.parse(data)[1]


                }
            },
        }
        // ,objListComboValue_RtnVal: {
            
        // }
        ,OnSuccessList:function(data){

                GetPopUp()
            
        }
    })

    // GetPopUp()
    function GetPopUp(){
        pngPn.getPopUp({
            strTitle: 'Update surcharge'
            , intTypeSize:1//------------1 small ---2 medium ---3 large
            , OnPanel: GetMainPanel
            , OnClosePopUp: function () {
                //------Chọn sự kiện khi Đóng PopUP
            }
        })
    }

    function GetMainPanel(_IdOrClassPp,_OnClosePp){

        IdOrClass_Main = _IdOrClassPp
        Obj_FN_Main.OnClosePp = _OnClosePp

        // Obj_FN_Main.OnClosePp(true)----------- chạy câu lệnh trong OnClosePopUp: function (){} khi tắt PopUp
        // Obj_FN_Main.OnClosePp(true,true)-----------Đóng Pop Up + chạy câu lệnh trong OnClosePopUp: function (){}

        var objPanel= {
            pnMain:{tag:'div',attr:'class=""',childTags:[{div:'class="row"'}]
                ,pnContent:{tag:'div',attr:'class="col-md-12"'}
                ,pnBtn:{tag:'div',attr:'class="col-md-12" '}
            }
        }

        var objEvtPanel = {}
        objEvtPanel.pnContent = function(_idOrClassPn){
            var IdOrClass_Pn = _idOrClassPn

            var strHtml = ''
            strHtml+= '         <div class="pn-margin-b-15"><b>Service:</b> '+Obj_Detail.strServiceName+'</div>'
            strHtml+= '         <div ìd="col-md-12" id="pnForm"></div>'
            strHtml+= '         <div ìd="col-md-12" id="pnPriceTotal" style="padding: 0 0 10px;margin-bottom: 15px;"></div>'

            $(IdOrClass_Pn).html(strHtml)

            Obj_FormInput = {
                intSglDblID:{title:'Quantity',attr:"class='col-md-6'",isRequire:true,IsRtn:true
                    ,input:{IsNoInput:true}
                    ,OnLoadHtml:function (_idOrClass_Pn) {
                        var strHtml = `
                            
                            <div class="pnQuantity" style="display: inline-flex;padding-bottom: 10px;">
                                <span style="width: 160px;">
                                    <a class="exp qty" style="padding: 0 10px;display: inline-block;background: #d8d8d8; cursor: pointer;">-</a>
                                    <div style="width: 40px;text-align: center;display: inline-block;">
                                        <span class="no-qty">0</span>
                                    </div>
                                    <a class="add qty" style="padding: 0 10px;display: inline-block;background: #d8d8d8; cursor: pointer;">+</a> 
                                </span>
                            </div>
                        `
                        $(_idOrClass_Pn).html(strHtml)

                        
                        $('.exp.qty',_idOrClass_Pn).click(function(){
                            var val = Int_Quantity

                            if(val>0){
                                val-=1
                            }
                            Int_Quantity = val

                            GetTotal()
                        })

                        
                        $('.add.qty',_idOrClass_Pn).click(function(){
                            var val = Int_Quantity

                            // if(val>0){
                                val+=1
                            // }
                            Int_Quantity = val

                            GetTotal()
                        })
                        

                    }
                },
            }
        
            pngPn.getForm({
                action: 1,
                objInput: Obj_FormInput,
                idOrClass: IdOrClass_Pn+' #pnForm',
                objDetail: Obj_Detail,
            })

            GetTotal()
            function GetTotal(){

                $('.no-qty', IdOrClass_Pn+' #pnForm').html(Int_Quantity)

                var arr = Arr_SurchargePrice.filter(function(item){ return item.intPaxFrom <=Int_Quantity  && item.intPaxTo >= Int_Quantity })

                Obj_Detail.dblUnitPrice = arr[0].dblPrice


                var strHtml = ''
                strHtml+= '<div style="font-size:20px;font-weight:bold;color:#1076FC"><b><span langkey="">'+pngElm.getLangKey({langkey:'pg_Main_Tour_PPbook_TblTotalPrice'})+'</span>:</b> '+ $.pngFormatPrice(Obj_Detail.dblUnitPrice*Int_Quantity)+'</div>'
                // if(dblOldTotalPrice)
                //     strHtml+= '<div style="text-decoration: line-through;">(<b>Giá cũ:</b> '+ $.pngFormatPrice(dblOldTotalPrice)+')</div>'
    
                $('#pnPriceTotal').html(strHtml)
            }


        }

        objEvtPanel.pnBtn = function(_idOrClassPn){
            var IdOrClass_Pn = _idOrClassPn

            var strHtml = ''
            // if(Obj_PaymentAmountAndPeriod['IsPayment']){
            //     strHtml+= '<button id="btnPayment" class="btn bg-primary txt-white">Thanh toán</button>'
            // }else{
                strHtml+= '<button id="btnSave" class="btn bg-primary txt-white" style="">Save</button>'
                // strHtml+= '<button id="btnHold" class="btn bg-warning txt-white">Giữ chỗ</button>'
            // }
            $(IdOrClass_Pn).html(strHtml)

            $('#btnSave',IdOrClass_Pn).click(function(){

                png.postListApiGetValue({           // Post list các Api phía trên và lấy về dữ liệu
                    objList_Api: ObjList_Api            // Tên các Object api đã khai báo phía trên 
                    // ,objList_ComboValue: ObjList_ComboValue // Tên các Object api dropdownlist đã khai báo phía trên 
                    ,objListApi_RtnVal: {           // Giá trị nhận về từ API
                        'UpdOrderBookingItemForHotel':{               // Tên api tương ứng với giá trị trả về
                            objParams_Cus: $.pngExtendObj(Obj_Detail,{
                                intQuantity: Int_Quantity
                            })
                            ,OnSuccess: function(data){
                                
                                Obj_FN_Main.OnClosePp(false,true)
                                options.OnSuccess.call()
                                $.Confirm({ strContent: '<span langkey="sys_Cfm_UpdSuccess"></span>' });
                            }
                        }
                    }
                })
            })

        }

        // ===================================
        
        pngPn.getPanelHtml({            // Get ra panel dạng html
            objPanel: objPanel
            ,objEvtPanel: objEvtPanel
            ,idOrClass: IdOrClass_Main  // Id or class chính
            ,OnChangeIdPn: function(_Fn){
                Obj_FN_Main.pnMain = _Fn    // Hàm đổi trang
            }   
        })

    }

}


coreSystem.getLoadPage({
                OnSuccess: function () {
$.ModulePage_ListOrderBookingMain();
                }
            })

    </script>
</app-content-display>